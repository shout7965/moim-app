<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>í™ˆ - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="page page-with-nav">
    <div class="page-header">
      <h1>ì–´ë””ì¯¤ì™”ì–´??</h1>
      <div id="profileArea" style="display:flex;align-items:center;gap:8px">
        <div class="avatar" id="myAvatar">?</div>
        <button class="btn btn-secondary btn-sm" id="logoutBtn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="page-content" style="padding-top:8px">
      <!-- ì§„í–‰ ì¤‘ì¸ ì•½ì† -->
      <div class="section-title">ì§„í–‰ ì¤‘ì¸ ì•½ì†</div>
      <div id="activeEmpty" class="text-sm text-muted" style="padding:8px 0;text-align:center">ì§„í–‰ ì¤‘ì¸ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      <div id="activeBanner" style="display:none;margin-bottom:12px"></div>

      <!-- ì˜ˆì • ì•½ì† -->
      <div class="flex-between">
        <div class="section-title">ì˜ˆì •ëœ ì•½ì†</div>
        <button class="btn btn-primary btn-sm" onclick="location.href='/pages/create-meeting.html'">+ ë§Œë“¤ê¸°</button>
      </div>

      <div id="pendingList">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“…</div>
          <div class="empty-state-title">ì˜ˆì •ëœ ì•½ì†ì´ ì—†ì–´ìš”</div>
          <div class="empty-state-sub">ì¹œêµ¬ë“¤ê³¼ ìƒˆ ì•½ì†ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</div>
        </div>
      </div>

      <!-- ì§€ë‚œ ì•½ì† (ì ‘ê¸°/í¼ì¹˜ê¸°) -->
      <div class="flex-between" style="margin-top:8px">
        <div class="section-title">ì§€ë‚œ ì•½ì†</div>
        <button class="btn btn-secondary btn-sm" id="toggleDoneBtn" type="button">ì—´ê¸°</button>
      </div>
      <div id="doneList" class="hidden">
        <div class="text-sm text-muted" style="padding:8px 0">ì•„ì§ ì™„ë£Œëœ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item active">
        <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/create-meeting.html'">
        <span class="nav-icon">â•</span><span>ì•½ì†</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/chat-list.html'">
        <span class="nav-icon">ğŸ’¬</span><span>ì±„íŒ…</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/friends.html'">
        <span class="nav-icon">ğŸ‘¥</span><span>ì¹œêµ¬</span>
      </button>
    </div>
  </nav>

  <script type="module">
    import { requireAuth }       from '/main.js';
    import { showToast, formatDateTime } from '/main.js';
    import { subscribeMyMeetings, syncUserMeetings, repairHostUserMeetings, getUser } from '/js/db.js';
    import { db } from '/js/firebase-config.js';
    import { doc, deleteDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { initFCM, setupForegroundMessages } from '/js/fcm.js';
    import { signOut } from '/js/auth.js';

    let myUid, myProfile;
    try {
      const s = await requireAuth();
      myUid = s.user.uid; myProfile = s.profile;
    } catch { location.href = '/index.html'; }

    // í”„ë¡œí•„ í‘œì‹œ
    const avatar = document.getElementById('myAvatar');
    if (myProfile.profileImg) {
      avatar.innerHTML = `<img src="${myProfile.profileImg}" alt="">`;
    } else {
      avatar.textContent = myProfile.nickname?.[0] || '?';
    }
    avatar.addEventListener('click', () => {
      document.getElementById('logoutBtn').style.display =
        document.getElementById('logoutBtn').style.display === 'none' ? '' : 'none';
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await signOut();
    });

    // FCM ì´ˆê¸°í™”
    initFCM(myUid).catch(console.warn);
    setupForegroundMessages();

    // ëˆ„ë½ëœ userMeetings ì¸ë±ìŠ¤ ë³´ì •
    syncUserMeetings(myUid).catch(console.warn);
    repairHostUserMeetings(myUid).catch(console.warn);

    // ì•½ì† ëª©ë¡ ì‹¤ì‹œê°„ êµ¬ë…
    const pendingEl = document.getElementById('pendingList');
    const doneEl    = document.getElementById('doneList');

    const activeBannerEl = document.getElementById('activeBanner');
    const activeEmptyEl  = document.getElementById('activeEmpty');
    const toggleDoneBtn  = document.getElementById('toggleDoneBtn');
    const userCache = new Map();

    let doneExpanded = false;
    toggleDoneBtn.addEventListener('click', () => {
      doneExpanded = !doneExpanded;
      doneEl.classList.toggle('hidden', !doneExpanded);
      toggleDoneBtn.textContent = doneExpanded ? 'ë‹«ê¸°' : 'ì—´ê¸°';
    });

    subscribeMyMeetings(myUid, (meetings) => {
      const isActiveNow = (m) => {
        if (m.status === 'active') return true;
        if (m.status !== 'pending' || !m.activeAt) return false;
        const at = m.activeAt.toDate ? m.activeAt.toDate() : new Date(m.activeAt);
        return at <= new Date();
      };

      const active  = meetings.filter(m => isActiveNow(m));
      const pending = meetings.filter(m => m.status === 'pending' && !isActiveNow(m));
      const done    = meetings.filter(m => m.status === 'done');

      // ì§„í–‰ ì¤‘ì¸ ëª¨ì„ ë°°ë„ˆ
      if (active.length) {
        activeEmptyEl.style.display = 'none';
        activeBannerEl.style.display = '';
        activeBannerEl.innerHTML = active.map(m => `
          <div class="active-meeting-banner" data-id="${m.id}">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <div class="status-dot dot-green dot-pulse"></div>
              <span class="text-xs text-green font-bold">ì§€ê¸ˆ ì§„í–‰ ì¤‘</span>
            </div>
            <div class="font-bold" style="margin-bottom:2px">${m.title}</div>
            <div class="text-xs text-muted">ğŸ“ ${m.place?.name || '-'}</div>
            <div style="margin-top:10px;text-align:right">
              <span class="text-xs text-accent">ğŸ“¡ ì‹¤ì‹œê°„ ì¶”ì  ë³´ê¸° â†’</span>
            </div>
          </div>`).join('');
        activeBannerEl.querySelectorAll('.active-meeting-banner').forEach(el => {
          el.addEventListener('click', () => {
            location.href = `/pages/tracking.html?id=${el.dataset.id}`;
          });
        });
      } else {
        activeBannerEl.style.display = 'none';
        activeBannerEl.innerHTML = '';
        activeEmptyEl.style.display = '';
      }

      if (!pending.length) {
        pendingEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“…</div>
            <div class="empty-state-title">ì˜ˆì •ëœ ì•½ì†ì´ ì—†ì–´ìš”</div>
            <div class="empty-state-sub">ì¹œêµ¬ë“¤ê³¼ ìƒˆ ì•½ì†ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</div>
          </div>`;
      } else {
        pendingEl.innerHTML = pending.map(m => renderMeetingCard(m)).join('');
        pendingEl.querySelectorAll('.meeting-card').forEach(el => {
          el.addEventListener('click', () => {
            location.href = `/pages/meeting.html?id=${el.dataset.id}`;
          });
        });
        bindMeetingActions(pendingEl);
        hydrateParticipants(pendingEl, pending);
      }

      if (!done.length) {
        doneEl.innerHTML = '<div class="text-sm text-muted" style="padding:8px 0">ì•„ì§ ì™„ë£Œëœ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        doneEl.innerHTML = done.slice(0, 5).map(m => renderMeetingCard(m)).join('');
        doneEl.querySelectorAll('.meeting-card').forEach(el => {
          el.addEventListener('click', () => {
            location.href = `/pages/meeting.html?id=${el.dataset.id}`;
          });
        });
        bindMeetingActions(doneEl);
        hydrateParticipants(doneEl, done.slice(0, 5));
      }
    });

    function bindMeetingActions(container) {
      container.querySelectorAll('.meeting-action-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const card = btn.closest('.meeting-card');
          const meetingId = card?.dataset.id;
          if (!meetingId) return;
          const action = btn.dataset.action;

          if (action === 'edit') {
            location.href = `/pages/create-meeting.html?id=${meetingId}`;
            return;
          }

          if (action === 'delete') {
            if (!confirm('ì•½ì†ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
              const memberSnap = await getDocs(collection(db, 'meetings', meetingId, 'members'));
              const memberUids = memberSnap.docs.map(d => d.id);
              await Promise.all(memberSnap.docs.map(d => deleteDoc(d.ref)));
              await deleteDoc(doc(db, 'meetings', meetingId));
              await Promise.all(memberUids.map(uid =>
                deleteDoc(doc(db, 'userMeetings', `${uid}_${meetingId}`)).catch(() => {})
              ));
              showToast('ì•½ì†ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } catch (e) {
              showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
            }
          }
        });
      });
    }

    function renderMeetingCard(m) {
      const badgeMap = {
        pending: ['badge-pending', 'ì˜ˆì •'],
        active:  ['badge-active',  'ì§„í–‰ì¤‘'],
        done:    ['badge-done',    'ì™„ë£Œ'],
      };
      const [badgeClass, badgeText] = badgeMap[m.status] || badgeMap.pending;
      const isHost = m.hostId === myUid;
      const canEdit = isHost && m.status !== 'done';

      return `
        <div class="meeting-card ${m.status}" data-id="${m.id}">
          <div class="meeting-card-top">
            <div class="meeting-title">${m.title}</div>
            <div class="meeting-top-right">
              <span class="meeting-badge ${badgeClass}">${badgeText}</span>
              ${isHost ? `
                <div class="meeting-actions">
                  ${canEdit ? '<button class="meeting-action-btn" data-action="edit" title="ìˆ˜ì •">âœï¸</button>' : ''}
                  <button class="meeting-action-btn" data-action="delete" title="ì‚­ì œ">âœ–</button>
                </div>
              ` : ''}
            </div>
          </div>
          <div class="meeting-meta">
            <div class="meeting-meta-row">
              <span class="icon">ğŸ“</span>
              <span>${m.place?.name || '-'}</span>
            </div>
            <div class="meeting-meta-row">
              <span class="icon">ğŸ•</span>
              <span>${formatDateTime(m.scheduledAt)}</span>
            </div>
            <div class="meeting-meta-row" data-participants="${m.id}">
              <span class="icon">ğŸ‘¥</span>
              <span class="text-muted">ì°¸ì—¬ì ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
            ${isHost ? '<div class="meeting-meta-row"><span class="icon">ğŸ‘‘</span><span class="text-accent">ë‚´ê°€ ë§Œë“  ì•½ì†</span></div>' : ''}
          </div>
        </div>`;
    }

    async function fetchUserCached(uid) {
      if (userCache.has(uid)) return userCache.get(uid);
      const user = await getUser(uid).catch(() => null);
      userCache.set(uid, user);
      return user;
    }

    function hydrateParticipants(container, meetings) {
      const rows = container.querySelectorAll('[data-participants]');
      const meetingMap = new Map(meetings.map(m => [m.id, m]));
      rows.forEach(async (row) => {
        const meetingId = row.dataset.participants;
        if (!meetingId) return;
        const meeting = meetingMap.get(meetingId);
        try {
          const snap = await getDocs(collection(db, 'meetings', meetingId, 'members'));
          const uids = snap.docs.map(d => d.id);
          if (!uids.length) {
            row.querySelector('span:last-child').textContent = 'ì°¸ì—¬ì ì—†ìŒ';
            return;
          }
          const namePromises = uids.slice(0, 3).map(async (uid) => {
            if (uid === myUid) return 'ë‚˜';
            const u = await fetchUserCached(uid);
            return u?.nickname || 'ì•Œ ìˆ˜ ì—†ìŒ';
          });
          const names = (await Promise.all(namePromises)).filter(Boolean);
          const count = uids.length;
          const more = count > names.length ? ` ì™¸ ${count - names.length}ëª…` : '';
          row.querySelector('span:last-child').textContent =
            `ì°¸ì—¬ì ${count}ëª…: ${names.join(', ')}${more}`;
        } catch {
          row.querySelector('span:last-child').textContent =
            meeting?.hostId === myUid ? 'ì°¸ì—¬ì ì •ë³´ ì—†ìŒ' : 'ì°¸ì—¬ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨';
        }
      });
    }
  </script>
</body>
</html>

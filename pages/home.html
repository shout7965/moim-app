<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>í™ˆ - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="page page-with-nav">
    <div class="page-header">
      <h1>ì–´ë””ì¯¤ì™”ì–´??</h1>
      <div id="profileArea" style="display:flex;align-items:center;gap:8px">
        <div class="avatar" id="myAvatar">?</div>
        <button class="btn btn-secondary btn-sm" id="logoutBtn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="page-content" style="padding-top:8px">
      <!-- ì§„í–‰ ì¤‘ì¸ ëª¨ì„ ë°°ë„ˆ -->
      <div id="activeBanner" style="display:none;margin-bottom:12px"></div>

      <!-- ì˜ˆì • ì•½ì† -->
      <div class="flex-between">
        <div class="section-title">ì˜ˆì •ëœ ì•½ì†</div>
        <button class="btn btn-primary btn-sm" onclick="location.href='/pages/create-meeting.html'">+ ë§Œë“¤ê¸°</button>
      </div>

      <div id="pendingList">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“…</div>
          <div class="empty-state-title">ì˜ˆì •ëœ ì•½ì†ì´ ì—†ì–´ìš”</div>
          <div class="empty-state-sub">ì¹œêµ¬ë“¤ê³¼ ìƒˆ ì•½ì†ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</div>
        </div>
      </div>

      <!-- ì§€ë‚œ ì•½ì† -->
      <div class="section-title" style="margin-top:8px">ì§€ë‚œ ì•½ì†</div>
      <div id="doneList">
        <div class="text-sm text-muted" style="padding:8px 0">ì•„ì§ ì™„ë£Œëœ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item active">
        <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/create-meeting.html'">
        <span class="nav-icon">â•</span><span>ì•½ì†</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/friends.html'">
        <span class="nav-icon">ğŸ‘¥</span><span>ì¹œêµ¬</span>
      </button>
    </div>
  </nav>

  <script type="module">
    import { requireAuth }       from '/main.js';
    import { showToast, formatDateTime } from '/main.js';
    import { subscribeMyMeetings } from '/js/db.js';
    import { initFCM, setupForegroundMessages } from '/js/fcm.js';
    import { signOut } from '/js/auth.js';

    let myUid, myProfile;
    try {
      const s = await requireAuth();
      myUid = s.user.uid; myProfile = s.profile;
    } catch { location.href = '/index.html'; }

    // í”„ë¡œí•„ í‘œì‹œ
    const avatar = document.getElementById('myAvatar');
    if (myProfile.profileImg) {
      avatar.innerHTML = `<img src="${myProfile.profileImg}" alt="">`;
    } else {
      avatar.textContent = myProfile.nickname?.[0] || '?';
    }
    avatar.addEventListener('click', () => {
      document.getElementById('logoutBtn').style.display =
        document.getElementById('logoutBtn').style.display === 'none' ? '' : 'none';
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await signOut();
    });

    // FCM ì´ˆê¸°í™”
    initFCM(myUid).catch(console.warn);
    setupForegroundMessages();

    // ì•½ì† ëª©ë¡ ì‹¤ì‹œê°„ êµ¬ë…
    const pendingEl = document.getElementById('pendingList');
    const doneEl    = document.getElementById('doneList');

    const activeBannerEl = document.getElementById('activeBanner');

    subscribeMyMeetings(myUid, (meetings) => {
      const active  = meetings.filter(m => m.status === 'active');
      const pending = meetings.filter(m => m.status === 'pending');
      const done    = meetings.filter(m => m.status === 'done');

      // ì§„í–‰ ì¤‘ì¸ ëª¨ì„ ë°°ë„ˆ
      if (active.length) {
        activeBannerEl.style.display = '';
        activeBannerEl.innerHTML = active.map(m => `
          <div class="active-meeting-banner" data-id="${m.id}">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <div class="status-dot dot-green dot-pulse"></div>
              <span class="text-xs text-green font-bold">ì§€ê¸ˆ ì§„í–‰ ì¤‘</span>
            </div>
            <div class="font-bold" style="margin-bottom:2px">${m.title}</div>
            <div class="text-xs text-muted">ğŸ“ ${m.place?.name || '-'}</div>
            <div style="margin-top:10px;text-align:right">
              <span class="text-xs text-accent">ğŸ“¡ ì‹¤ì‹œê°„ ì¶”ì  ë³´ê¸° â†’</span>
            </div>
          </div>`).join('');
        activeBannerEl.querySelectorAll('.active-meeting-banner').forEach(el => {
          el.addEventListener('click', () => {
            location.href = `/pages/tracking.html?id=${el.dataset.id}`;
          });
        });
      } else {
        activeBannerEl.style.display = 'none';
        activeBannerEl.innerHTML = '';
      }

      if (!pending.length) {
        pendingEl.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“…</div>
            <div class="empty-state-title">ì˜ˆì •ëœ ì•½ì†ì´ ì—†ì–´ìš”</div>
            <div class="empty-state-sub">ì¹œêµ¬ë“¤ê³¼ ìƒˆ ì•½ì†ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”</div>
          </div>`;
      } else {
        pendingEl.innerHTML = pending.map(m => renderMeetingCard(m)).join('');
        pendingEl.querySelectorAll('.meeting-card').forEach(el => {
          el.addEventListener('click', () => {
            location.href = `/pages/meeting.html?id=${el.dataset.id}`;
          });
        });
      }

      if (!done.length) {
        doneEl.innerHTML = '<div class="text-sm text-muted" style="padding:8px 0">ì•„ì§ ì™„ë£Œëœ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      } else {
        doneEl.innerHTML = done.slice(0, 5).map(m => renderMeetingCard(m)).join('');
      }
    });

    function renderMeetingCard(m) {
      const badgeMap = {
        pending: ['badge-pending', 'ì˜ˆì •'],
        active:  ['badge-active',  'ì§„í–‰ì¤‘'],
        done:    ['badge-done',    'ì™„ë£Œ'],
      };
      const [badgeClass, badgeText] = badgeMap[m.status] || badgeMap.pending;
      const isHost = m.hostId === myUid;

      return `
        <div class="meeting-card" data-id="${m.id}">
          <div class="meeting-card-top">
            <div class="meeting-title">${m.title}</div>
            <span class="meeting-badge ${badgeClass}">${badgeText}</span>
          </div>
          <div class="meeting-meta">
            <div class="meeting-meta-row">
              <span class="icon">ğŸ“</span>
              <span>${m.place?.name || '-'}</span>
            </div>
            <div class="meeting-meta-row">
              <span class="icon">ğŸ•</span>
              <span>${formatDateTime(m.scheduledAt)}</span>
            </div>
            ${isHost ? '<div class="meeting-meta-row"><span class="icon">ğŸ‘‘</span><span class="text-accent">ë‚´ê°€ ë§Œë“  ì•½ì†</span></div>' : ''}
          </div>
        </div>`;
    }
  </script>
</body>
</html>

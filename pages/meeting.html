<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì•½ì† ìƒì„¸ - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="page">
    <div class="page-header">
      <button class="btn-icon-round" onclick="location.href='/pages/home.html'">â†</button>
      <h1 id="meetingTitle">ì•½ì† ìƒì„¸</h1>
      <button class="btn-icon-round" id="shareBtn" title="ê³µìœ ">â†—</button>
    </div>

    <div class="page-content pb-safe">
      <!-- ì•½ì† ì •ë³´ -->
      <div class="card">
        <div class="meeting-meta" style="gap:8px">
          <div class="meeting-meta-row">
            <span class="icon">ğŸ“</span>
            <div>
              <div class="font-bold text-sm" id="placeName">-</div>
              <div class="text-xs text-muted" id="placeAddr">-</div>
            </div>
          </div>
          <div class="meeting-meta-row">
            <span class="icon">ğŸ•</span>
            <span id="scheduledAt" class="text-sm">-</span>
          </div>
        </div>
      </div>

      <!-- ë‚´ ìƒíƒœ -->
      <div id="myStatusArea"></div>

      <!-- ì´ë™ìˆ˜ë‹¨ ì„ íƒ (ìˆ˜ë½í•œ ê²½ìš°ë§Œ) -->
      <div id="transportArea" class="hidden">
        <div class="section-title">ì´ë™ìˆ˜ë‹¨</div>
        <div class="transport-grid">
          <button class="transport-btn" data-transport="walk">
            <span class="transport-icon">ğŸš¶</span><span>ë„ë³´</span>
          </button>
          <button class="transport-btn" data-transport="bike">
            <span class="transport-icon">ğŸš²</span><span>ìì „ê±°</span>
          </button>
          <button class="transport-btn" data-transport="transit">
            <span class="transport-icon">ğŸšŒ</span><span>ëŒ€ì¤‘êµí†µ</span>
          </button>
        </div>
      </div>

      <!-- ì‹¤ì‹œê°„ ì¶”ì  ì‹œì‘ ë²„íŠ¼ -->
      <div id="trackingBtnArea" class="hidden">
        <button class="btn btn-primary btn-block" id="startTrackingBtn">
          ğŸ“ ì‹¤ì‹œê°„ ìœ„ì¹˜ ê³µìœ  ì‹œì‘
        </button>
      </div>

      <!-- ì°¸ì—¬ì ëª©ë¡ -->
      <div class="section-title">ì°¸ì—¬ì</div>
      <div id="memberList"></div>

      <!-- í˜¸ìŠ¤íŠ¸ ì „ìš©: ì•½ì† ì‚­ì œ -->
      <div id="hostActions" class="hidden" style="margin-top:8px">
        <button class="btn btn-danger btn-block" id="deleteMeetingBtn">ì•½ì† ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuth, formatDateTime, showToast, getParam } from '/main.js';
    import { getMeeting, getMember, setMember, subscribeMembers, updateMeeting } from '/js/db.js';
    import { shareMeetingLink } from '/js/invite.js';
    import { WORKER_URL } from '/js/firebase-config.js';
    import { doc, deleteDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { db } from '/js/firebase-config.js';

    let myUid, myProfile, meeting, myMember;
    const meetingId = getParam('id');
    if (!meetingId) { location.href = '/pages/home.html'; }

    try {
      const s = await requireAuth();
      myUid = s.user.uid; myProfile = s.profile;
    } catch { location.href = '/index.html'; }

    // ì•½ì† ì •ë³´ ë¡œë“œ
    meeting = await getMeeting(meetingId);
    if (!meeting) { showToast('ì•½ì†ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); location.href = '/pages/home.html'; }

    myMember = await getMember(meetingId, myUid);

    // í—¤ë” ë Œë”ë§
    document.getElementById('meetingTitle').textContent = meeting.title;
    document.getElementById('placeName').textContent    = meeting.place?.name || '-';
    document.getElementById('placeAddr').textContent    = meeting.place?.address || '';
    document.getElementById('scheduledAt').textContent  = formatDateTime(meeting.scheduledAt);

    // ê³µìœ 
    document.getElementById('shareBtn').addEventListener('click', () =>
      shareMeetingLink(meetingId, meeting.title));

    // ë‚´ ìƒíƒœ UI
    renderMyStatus();

    function renderMyStatus() {
      const area = document.getElementById('myStatusArea');
      const transport = document.getElementById('transportArea');
      const trackingArea = document.getElementById('trackingBtnArea');

      if (!myMember) {
        area.innerHTML = `
          <div class="card-sm" style="text-align:center">
            <div class="text-sm text-muted">ì´ ì•½ì†ì— ì°¸ì—¬ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.</div>
          </div>`;
        return;
      }

      const statusMap = {
        invited:  'ì´ˆëŒ€ë°›ì•˜ì–´ìš”',
        accepted: 'ì°¸ì—¬ í™•ì •',
        declined: 'ì°¸ì—¬ ê±°ì ˆ',
        arrived:  'ë„ì°© ì™„ë£Œ',
      };

      area.innerHTML = `
        <div class="card-sm flex-between">
          <div class="text-sm">ë‚´ ìƒíƒœ: <span class="font-bold">${statusMap[myMember.status] || '-'}</span></div>
          <div style="display:flex;gap:6px" id="statusBtns"></div>
        </div>`;

      const btns = document.getElementById('statusBtns');
      if (myMember.status === 'invited') {
        btns.innerHTML = `
          <button class="btn btn-success btn-sm" id="acceptBtn">ìˆ˜ë½</button>
          <button class="btn btn-danger btn-sm" id="declineBtn">ê±°ì ˆ</button>`;
        btns.querySelector('#acceptBtn').addEventListener('click', () => changeStatus('accepted'));
        btns.querySelector('#declineBtn').addEventListener('click', () => changeStatus('declined'));
      }

      // ìˆ˜ë½í•œ ê²½ìš° ì´ë™ìˆ˜ë‹¨ + ì¶”ì  ë²„íŠ¼
      if (myMember.status === 'accepted' || myMember.status === 'arrived') {
        transport.classList.remove('hidden');
        if (myMember.transport) {
          document.querySelectorAll('.transport-btn').forEach(b => {
            b.classList.toggle('selected', b.dataset.transport === myMember.transport);
          });
        }
        if (meeting.status !== 'done') {
          trackingArea.classList.remove('hidden');
        }
      }
    }

    async function changeStatus(status) {
      await setMember(meetingId, myUid, { status });
      myMember.status = status;
      renderMyStatus();

      // ì•½ì†ì´ active ìƒíƒœê°€ ì•„ë‹ˆë©´ activeë¡œ ë³€ê²½
      if (status === 'accepted' && meeting.status === 'pending') {
        await updateMeeting(meetingId, { status: 'active' });
      }

      showToast(status === 'accepted' ? 'ì•½ì†ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤!' : 'ì•½ì†ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.', 'info');
    }

    // ì´ë™ìˆ˜ë‹¨ ì„ íƒ
    document.querySelectorAll('.transport-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const t = btn.dataset.transport;
        document.querySelectorAll('.transport-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        await setMember(meetingId, myUid, { transport: t });
        myMember.transport = t;
        showToast('ì´ë™ìˆ˜ë‹¨ì´ ì €ì¥ëìŠµë‹ˆë‹¤', 'success');
      });
    });

    // ì¶”ì  ì‹œì‘
    document.getElementById('startTrackingBtn')?.addEventListener('click', () => {
      location.href = `/pages/tracking.html?id=${meetingId}`;
    });

    // ì°¸ì—¬ì ëª©ë¡ ì‹¤ì‹œê°„ êµ¬ë…
    subscribeMembers(meetingId, (members) => {
      const el = document.getElementById('memberList');
      if (!members.length) {
        el.innerHTML = '<div class="text-sm text-muted">ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      el.innerHTML = members.map(m => {
        const statusDotMap = {
          invited:  'dot-yellow', accepted: 'dot-green',
          declined: 'dot-gray',   arrived:  'dot-green dot-pulse',
        };
        const statusTextMap = {
          invited: 'ì´ˆëŒ€ë¨', accepted: 'ì°¸ì—¬í™•ì •',
          declined: 'ê±°ì ˆ', arrived: 'ë„ì°©ì™„ë£Œ',
        };
        return `
          <div class="friend-item">
            <div class="avatar">
              ${m.profileImg ? `<img src="${m.profileImg}">` : (m.nickname?.[0] || '?')}
            </div>
            <div class="friend-info">
              <div class="friend-name">${m.nickname} ${m.uid === myUid ? '(ë‚˜)' : ''}</div>
              <div class="text-xs text-muted">${m.transport ? { walk:'ë„ë³´', bike:'ìì „ê±°', transit:'ëŒ€ì¤‘êµí†µ' }[m.transport] + ' Â· ' : ''}${statusTextMap[m.status] || '-'}</div>
            </div>
            <div class="status-dot ${statusDotMap[m.status] || 'dot-gray'}"></div>
          </div>`;
      }).join('');
    });

    // í˜¸ìŠ¤íŠ¸ ì „ìš© ê¸°ëŠ¥
    if (meeting.hostId === myUid) {
      document.getElementById('hostActions').classList.remove('hidden');
      document.getElementById('deleteMeetingBtn').addEventListener('click', async () => {
        if (!confirm('ì•½ì†ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
          // ë©¤ë²„ ì„œë¸Œì»¬ë ‰ì…˜ ì‚­ì œ
          const memberSnap = await getDocs(collection(db, 'meetings', meetingId, 'members'));
          await Promise.all(memberSnap.docs.map(d => deleteDoc(d.ref)));
          await deleteDoc(doc(db, 'meetings', meetingId));
          showToast('ì•½ì†ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
          location.href = '/pages/home.html';
        } catch (e) {
          showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
        }
      });
    }
  </script>
</body>
</html>

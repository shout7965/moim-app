<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì•½ì† ìƒì„¸ - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="page page-with-nav">
    <div class="page-header">
      <button class="btn-icon-round" onclick="location.href='/pages/home.html'">â†</button>
      <h1 id="meetingTitle"></h1>
      <button class="btn-icon-round" id="shareBtn" title="ê³µìœ ">â†—</button>
    </div>

    <div class="page-content pb-safe">
      <!-- ì•½ì† ì •ë³´ -->
      <div class="card">
        <div class="meeting-meta" style="gap:8px">
          <div class="meeting-meta-row">
            <span class="icon">ğŸ“</span>
            <div>
              <div class="font-bold text-sm" id="placeName">-</div>
              <div class="text-xs text-muted" id="placeAddr">-</div>
            </div>
          </div>
          <div class="meeting-meta-row">
            <span class="icon">ğŸ•</span>
            <span id="scheduledAt" class="text-sm">-</span>
          </div>
        </div>
      </div>

      <!-- ë‚´ ìƒíƒœ -->
      <div id="myStatusArea"></div>

      <!-- ì´ë™ìˆ˜ë‹¨ ì„ íƒ (ìˆ˜ë½í•œ ê²½ìš°ë§Œ) -->
      <div id="transportArea" class="hidden">
        <div class="section-title">ì´ë™ìˆ˜ë‹¨</div>
        <div class="transport-grid" style="grid-template-columns:repeat(4,1fr)">
          <button class="transport-btn" data-transport="walk">
            <span class="transport-icon">ğŸš¶</span><span>ë„ë³´</span>
          </button>
          <button class="transport-btn" data-transport="bike">
            <span class="transport-icon">ğŸš²</span><span>ìì „ê±°</span>
          </button>
          <button class="transport-btn" data-transport="transit">
            <span class="transport-icon">ğŸšŒ</span><span>ëŒ€ì¤‘êµí†µ</span>
          </button>
          <button class="transport-btn" data-transport="car">
            <span class="transport-icon">ğŸš—</span><span>ìê°€ìš©</span>
          </button>
        </div>
      </div>

      <!-- ì‹¤ì‹œê°„ ì¶”ì  ì‹œì‘ ë²„íŠ¼ -->
      <div id="trackingBtnArea" class="hidden">
        <button class="btn btn-primary btn-block" id="startTrackingBtn">
          ğŸ“ ì‹¤ì‹œê°„ ìœ„ì¹˜ ê³µìœ /ì¡°íšŒ
        </button>
      </div>

      <!-- ì°¸ì—¬ì ëª©ë¡ -->
      <div class="section-title">ì°¸ì—¬ì</div>
      <div id="memberList"></div>

      <!-- í˜¸ìŠ¤íŠ¸ ì „ìš©: ì¹œêµ¬ ì´ˆëŒ€ + ì•½ì† ì‚­ì œ -->
      <div id="hostActions" class="hidden" style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
        <button class="btn btn-secondary btn-block" id="inviteFriendBtn">ğŸ‘¥ ì¹œêµ¬ ì´ˆëŒ€</button>
        <button class="btn btn-danger btn-block" id="deleteMeetingBtn">ì•½ì† ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬ -->
  <div id="inviteModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-title">ì¹œêµ¬ ì´ˆëŒ€</div>
      <div id="inviteFriendList" style="max-height:320px;overflow-y:auto"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-secondary btn-sm" style="flex:1" id="inviteCancelBtn">ë‹«ê¸°</button>
        <button class="btn btn-primary btn-sm" style="flex:1" id="inviteConfirmBtn">ì´ˆëŒ€</button>
      </div>
    </div>
  </div>

  <!-- ì¶œë°œìœ„ì¹˜ ì„¤ì • ëª¨ë‹¬ -->
  <div id="departureModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-title">ì¶œë°œ ìœ„ì¹˜ ì„¤ì •</div>
      <button class="btn btn-primary btn-block" id="departAutoBtn">
        ğŸ“ í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì¶œë°œ
      </button>
      <div style="text-align:center;color:var(--text3);font-size:12px;margin:12px 0">ë˜ëŠ” ì§ì ‘ ì§€ì •</div>
      <div class="input-row" style="margin-bottom:8px">
        <input id="departSearchInput" class="input" placeholder="ì¶œë°œì§€ ê²€ìƒ‰...">
        <button class="btn btn-secondary btn-sm" id="departSearchBtn">ê²€ìƒ‰</button>
      </div>
      <div id="departSearchResults"></div>
      <button class="btn btn-secondary btn-sm btn-block" id="departCancelBtn" style="margin-top:10px">ìœ„ì¹˜ ì—†ì´ ìˆ˜ë½</button>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item" onclick="location.href='/pages/home.html'">
        <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/create-meeting.html'">
        <span class="nav-icon">â•</span><span>ì•½ì†</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/chat-list.html'">
        <span class="nav-icon">ğŸ’¬</span><span>ì±„íŒ…</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/friends.html'">
        <span class="nav-icon">ğŸ‘¥</span><span>ì¹œêµ¬</span>
      </button>
    </div>
  </nav>

  <script type="module">
    import { requireAuth, formatDateTime, showToast, getParam } from '/main.js';
    import { getMeeting, getMember, setMember, subscribeMembers, updateMeeting, getFriends, inviteMember, joinMeetingByLink } from '/js/db.js';
    import { shareMeetingLink } from '/js/invite.js';
    import { WORKER_URL } from '/js/firebase-config.js';
    import { doc, deleteDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { db } from '/js/firebase-config.js';

    // ëª¨ë“ˆ ìŠ¤ì½”í”„ ìƒíƒœ (IIFE ë‚´ë¶€ì—ì„œ í• ë‹¹)
    let myUid, myProfile, meeting, myMember;
    const meetingId = getParam('id');
    if (!meetingId) { location.href = '/pages/home.html'; }

    // changeStatusëŠ” IIFE ë‚´ì—ì„œ ì •ì˜ë˜ì§€ë§Œ initDepartureModal ì´ë²¤íŠ¸ì—ì„œ ì°¸ì¡°
    let changeStatus = async () => {};

    // â”€â”€ ë™ê¸° í•¨ìˆ˜ë“¤ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ìš©) â”€â”€
    function closeDepartureModal() {
      document.getElementById('departureModal').classList.add('hidden');
      document.getElementById('departSearchResults').innerHTML = '';
      document.getElementById('departSearchInput').value = '';
    }

    async function searchDeparture(q) {
      const res  = await fetch(`${WORKER_URL}/api/search-places?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      const el   = document.getElementById('departSearchResults');
      if (!data.results?.length) {
        el.innerHTML = '<div class="text-sm text-muted" style="padding:8px 0">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      el.innerHTML = data.results.map((r, i) => `
        <div class="friend-item" style="cursor:pointer;padding:10px 0" data-idx="${i}">
          <div style="flex:1;min-width:0">
            <div class="text-sm font-bold">${r.name}</div>
            <div class="text-xs text-muted">${r.address}</div>
          </div>
        </div>`).join('');
      data.results.forEach((r, i) => {
        el.querySelector(`[data-idx="${i}"]`).addEventListener('click', async () => {
          closeDepartureModal();
          await changeStatus('accepted', { lat: r.lat, lng: r.lng, name: r.name });
        });
      });
    }

    function initDepartureModal() {
      document.getElementById('departAutoBtn').addEventListener('click', async () => {
        closeDepartureModal();
        await changeStatus('accepted', null);
      });
      document.getElementById('departCancelBtn').addEventListener('click', async () => {
        closeDepartureModal();
        await changeStatus('accepted', null);
      });
      document.getElementById('departSearchBtn').addEventListener('click', () => {
        const q = document.getElementById('departSearchInput').value.trim();
        if (q) searchDeparture(q);
      });
      document.getElementById('departSearchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const q = e.target.value.trim();
          if (q) searchDeparture(q);
        }
      });
    }

    initDepartureModal();

    // â”€â”€ ë¹„ë™ê¸° ì´ˆê¸°í™” â”€â”€
    (async () => {
      try {
        const s = await requireAuth();
        myUid = s.user.uid; myProfile = s.profile;
      } catch { location.href = '/index.html'; return; }

      // ì•½ì† ì •ë³´ ë¡œë“œ
      try {
        meeting = await getMeeting(meetingId);
      } catch (e) {
        showToast('ì•½ì† ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'error');
        document.getElementById('myStatusArea').innerHTML = `
          <div class="card-sm" style="text-align:center">
            <div class="text-sm text-muted">ì•½ì† ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>
            <div class="text-xs text-muted" style="margin-top:6px">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
          </div>`;
        return;
      }
      if (!meeting) {
        showToast('ì•½ì†ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'error');
        document.getElementById('myStatusArea').innerHTML = `
          <div class="card-sm" style="text-align:center">
            <div class="text-sm text-muted">ì•½ì†ì´ ì—†ê±°ë‚˜ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
          </div>`;
        return;
      }

      try {
        myMember = await getMember(meetingId, myUid);
      } catch (e) {
        // ë¹„ë©¤ë²„ëŠ” ê¶Œí•œ ì˜¤ë¥˜ê°€ ë‚  ìˆ˜ ìˆìœ¼ë¯€ë¡œ nullë¡œ ì²˜ë¦¬
        console.warn('getMember error:', e);
        myMember = null;
      }

      // active ì•½ì† + ìˆ˜ë½í•œ ë©¤ë²„ â†’ ë°”ë¡œ ì¶”ì  í˜ì´ì§€ë¡œ (noredirect=1ì´ë©´ ìœ ì§€)
      if (
        meeting.status === 'active' &&
        myMember && (myMember.status === 'accepted' || myMember.status === 'arrived') &&
        getParam('noredirect') !== '1'
      ) {
        location.href = `/pages/tracking.html?id=${meetingId}`;
        return;
      }

      // í—¤ë” ë Œë”ë§
      document.getElementById('meetingTitle').textContent = meeting.title;
      document.getElementById('placeName').textContent    = meeting.place?.name || '-';
      document.getElementById('placeAddr').textContent    = meeting.place?.address || '';
      document.getElementById('scheduledAt').textContent  = formatDateTime(meeting.scheduledAt);

      // ê³µìœ 
      document.getElementById('shareBtn').addEventListener('click', () =>
        shareMeetingLink(meetingId, meeting.title));

      // changeStatus ì‹¤ì œ êµ¬í˜„ (renderMyStatus í˜¸ì¶œ ì „ì— í• ë‹¹)
      changeStatus = async (status, departure = null) => {
        const data = { status };
        if (!myMember?.nickname) {
          data.nickname = myProfile?.nickname || 'ìµëª…';
          data.profileImg = myProfile?.profileImg || null;
        }
        if (status === 'accepted' && departure) {
          data.departureLat  = departure.lat;
          data.departureLng  = departure.lng;
          data.departureName = departure.name;
        }
        await setMember(meetingId, myUid, data);
        myMember = { ...(myMember || {}), ...data };
        renderMyStatus();

        if (status === 'accepted' && meeting.status === 'pending') {
          await updateMeeting(meetingId, { status: 'active' });
        }

        const msg = status === 'accepted'
          ? (departure ? `'${departure.name}'ì—ì„œ ì¶œë°œí•˜ëŠ” ê²ƒìœ¼ë¡œ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤!` : 'ì•½ì†ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤!')
          : 'ì•½ì†ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.';
        showToast(msg, 'info');
      };

      // ë‚´ ìƒíƒœ UI
      renderMyStatus();

      // ì°¸ì—¬ì ëª©ë¡ êµ¬ë… (ë©¤ë²„/í˜¸ìŠ¤íŠ¸ë§Œ)
      let membersSubscribed = false;
      function ensureMemberSubscription() {
        if (membersSubscribed) return;
        membersSubscribed = true;
        subscribeMembers(meetingId, (members) => {
          const el = document.getElementById('memberList');
          if (!members.length) {
            el.innerHTML = '<div class="text-sm text-muted">ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
          }
          el.innerHTML = members.map(m => {
            const statusDotMap = {
              invited:  'dot-yellow', accepted: 'dot-green',
              declined: 'dot-gray',   arrived:  'dot-green dot-pulse',
            };
            const statusTextMap = {
              invited: 'ì´ˆëŒ€ë¨', accepted: 'ì°¸ì—¬í™•ì •',
              declined: 'ê±°ì ˆ', arrived: 'ë„ì°©ì™„ë£Œ',
            };
            return `
              <div class="friend-item">
                <div class="avatar">
                  ${m.profileImg ? `<img src="${m.profileImg}">` : (m.nickname?.[0] || '?')}
                </div>
                <div class="friend-info">
                  <div class="friend-name">${m.nickname} ${m.uid === myUid ? '(ë‚˜)' : ''}</div>
                  <div class="text-xs text-muted">${m.transport ? { walk:'ë„ë³´', bike:'ìì „ê±°', transit:'ëŒ€ì¤‘êµí†µ', car:'ìê°€ìš©' }[m.transport] + ' Â· ' : ''}${statusTextMap[m.status] || '-'}</div>
                </div>
                <div class="status-dot ${statusDotMap[m.status] || 'dot-gray'}"></div>
              </div>`;
          }).join('');
        });
      }

      function renderMyStatus() {
        const area = document.getElementById('myStatusArea');
        const transport = document.getElementById('transportArea');
        const trackingArea = document.getElementById('trackingBtnArea');

        if (!myMember) {
          transport.classList.add('hidden');
          trackingArea.classList.add('hidden');
          area.innerHTML = `
            <div class="card-sm" style="text-align:center">
              <div class="text-sm text-muted" style="margin-bottom:8px">ì´ ì•½ì†ì— ì°¸ì—¬ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.</div>
              <button class="btn btn-primary btn-sm" id="joinBtn">ì°¸ì—¬í•˜ê¸°</button>
            </div>`;
          area.querySelector('#joinBtn').addEventListener('click', async () => {
            try {
              await joinMeetingByLink(meetingId, myUid, myProfile, meeting, 'invited');
              myMember = {
                uid: myUid,
                nickname: myProfile?.nickname || 'ìµëª…',
                profileImg: myProfile?.profileImg || null,
                status: 'invited',
              };
              renderMyStatus();
              ensureMemberSubscription();
              document.getElementById('departureModal').classList.remove('hidden');
            } catch (e) {
              showToast('ì°¸ì—¬ ì‹¤íŒ¨: ' + e.message, 'error');
            }
          });
          return;
        }

        const statusMap = {
          invited:  'ì´ˆëŒ€ë°›ì•˜ì–´ìš”',
          accepted: 'ì°¸ì—¬ í™•ì •',
          declined: 'ì°¸ì—¬ ê±°ì ˆ',
          arrived:  'ë„ì°© ì™„ë£Œ',
        };

        area.innerHTML = `
          <div class="card-sm flex-between">
            <div class="text-sm">ë‚´ ìƒíƒœ: <span class="font-bold">${statusMap[myMember.status] || '-'}</span></div>
            <div style="display:flex;gap:6px" id="statusBtns"></div>
          </div>`;

        const btns = document.getElementById('statusBtns');
        if (myMember.status === 'invited') {
          btns.innerHTML = `
            <button class="btn btn-success btn-sm" id="acceptBtn">ìˆ˜ë½</button>
            <button class="btn btn-danger btn-sm" id="declineBtn">ê±°ì ˆ</button>`;
          btns.querySelector('#acceptBtn').addEventListener('click', () =>
            document.getElementById('departureModal').classList.remove('hidden'));
          btns.querySelector('#declineBtn').addEventListener('click', () => changeStatus('declined'));
        }

        // ìˆ˜ë½í•œ ê²½ìš° ì´ë™ìˆ˜ë‹¨ + ì¶”ì  ë²„íŠ¼
        if (myMember.status === 'accepted' || myMember.status === 'arrived') {
          transport.classList.remove('hidden');
          if (myMember.transport) {
            document.querySelectorAll('.transport-btn').forEach(b => {
              b.classList.toggle('selected', b.dataset.transport === myMember.transport);
            });
          }
          if (meeting.status !== 'done') {
            trackingArea.classList.remove('hidden');
          }
        }
      }

      // ë©¤ë²„/í˜¸ìŠ¤íŠ¸ë©´ ì°¸ì—¬ì ëª©ë¡ í™œì„±í™”
      if (myMember || meeting.hostId === myUid) {
        ensureMemberSubscription();
      } else {
        document.getElementById('memberList').innerHTML =
          '<div class="text-sm text-muted">ì°¸ì—¬í•˜ë©´ ì°¸ì—¬ì ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆì–´ìš”.</div>';
      }
      // ì´ë™ìˆ˜ë‹¨ ì„ íƒ
      document.querySelectorAll('.transport-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const t = btn.dataset.transport;
          document.querySelectorAll('.transport-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          await setMember(meetingId, myUid, { transport: t });
          myMember.transport = t;
          showToast('ì´ë™ìˆ˜ë‹¨ì´ ì €ì¥ëìŠµë‹ˆë‹¤', 'success');
        });
      });

      // ì¶”ì  ì‹œì‘
      document.getElementById('startTrackingBtn')?.addEventListener('click', () => {
        location.href = `/pages/tracking.html?id=${meetingId}`;
      });

      // í˜¸ìŠ¤íŠ¸ ì „ìš© ê¸°ëŠ¥
      if (meeting.hostId === myUid) {
        document.getElementById('hostActions').classList.remove('hidden');

        // ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬
        let currentMemberUids = [];
        subscribeMembers(meetingId, (members) => {
          currentMemberUids = members.map(m => m.uid);
        });

        document.getElementById('inviteFriendBtn').addEventListener('click', async () => {
          const friends = await getFriends(myProfile.friends || []);
          const invitable = friends.filter(f => !currentMemberUids.includes(f.uid));
          const listEl = document.getElementById('inviteFriendList');
          if (!invitable.length) {
            listEl.innerHTML = '<div class="text-sm text-muted" style="padding:12px 0;text-align:center">ì´ˆëŒ€í•  ìˆ˜ ìˆëŠ” ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          } else {
            listEl.innerHTML = invitable.map(f => `
              <div class="friend-check-item" data-uid="${f.uid}" data-nickname="${f.nickname}" data-img="${f.profileImg||''}">
                <div class="avatar">
                  ${f.profileImg ? `<img src="${f.profileImg}">` : (f.nickname?.[0]||'?')}
                </div>
                <div class="friend-info">
                  <div class="friend-name">${f.nickname}</div>
                </div>
                <div class="check-icon" style="margin-left:auto;font-size:18px;color:var(--text3)">â—‹</div>
              </div>`).join('');
            listEl.querySelectorAll('.friend-check-item').forEach(item => {
              item.addEventListener('click', () => {
                item.classList.toggle('selected');
                item.querySelector('.check-icon').textContent = item.classList.contains('selected') ? 'âœ…' : 'â—‹';
              });
            });
          }
          document.getElementById('inviteModal').classList.remove('hidden');
        });

        document.getElementById('inviteCancelBtn').addEventListener('click', () =>
          document.getElementById('inviteModal').classList.add('hidden'));

        document.getElementById('inviteConfirmBtn').addEventListener('click', async () => {
          const selected = [...document.querySelectorAll('.friend-check-item.selected')];
          if (!selected.length) { showToast('ì´ˆëŒ€í•  ì¹œêµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'info'); return; }
          document.getElementById('inviteConfirmBtn').disabled = true;
          try {
            await Promise.all(selected.map(el =>
              inviteMember(meetingId, el.dataset.uid, el.dataset.nickname, el.dataset.img || null, meeting)
            ));
            document.getElementById('inviteModal').classList.add('hidden');
            showToast(`${selected.length}ëª…ì„ ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤!`, 'success');
          } catch (e) {
            showToast('ì´ˆëŒ€ ì‹¤íŒ¨: ' + e.message, 'error');
          } finally {
            document.getElementById('inviteConfirmBtn').disabled = false;
          }
        });

        document.getElementById('deleteMeetingBtn').addEventListener('click', async () => {
          if (!confirm('ì•½ì†ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
          try {
            const memberSnap = await getDocs(collection(db, 'meetings', meetingId, 'members'));
            const memberUids = memberSnap.docs.map(d => d.id);
            await Promise.all(memberSnap.docs.map(d => deleteDoc(d.ref)));
            await deleteDoc(doc(db, 'meetings', meetingId));
            await Promise.all(memberUids.map(uid =>
              deleteDoc(doc(db, 'userMeetings', `${uid}_${meetingId}`)).catch(() => {})
            ));
            showToast('ì•½ì†ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            location.href = '/pages/home.html';
          } catch (e) {
            showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
          }
        });
      }
    })(); // async IIFE ë
  </script>
</body>
</html>

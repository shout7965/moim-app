<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì•½ì† ë§Œë“¤ê¸° - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    #map { height: 220px; border-radius: var(--radius); overflow: hidden; }
    .friend-check-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: var(--radius-sm);
      border: 2px solid var(--border); cursor: pointer;
      transition: border-color 0.15s;
    }
    .friend-check-item.selected { border-color: var(--accent); background: rgba(108,99,255,0.08); }
    .friend-check-item .avatar { flex-shrink: 0; }
    .place-results {
      max-height: 200px; overflow-y: auto;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg3);
    }
  </style>
</head>
<body>
  <div class="page page-with-nav">
    <div class="page-header">
      <button class="btn-icon-round" onclick="history.back()">â†</button>
      <h1 id="pageTitle">ì•½ì† ë§Œë“¤ê¸°</h1>
    </div>

    <div class="page-content pb-safe">
      <!-- ì•½ì† ì œëª© -->
      <div class="input-group">
        <label class="input-label">ì•½ì† ì´ë¦„</label>
        <input class="input" id="titleInput" placeholder="ì˜ˆ: ê°•ë‚¨ì—­ ì ì‹¬" maxlength="30" />
      </div>

      <!-- ë‚ ì§œ/ì‹œê°„ -->
      <div class="input-group">
        <label class="input-label">ë‚ ì§œ & ì‹œê°„</label>
        <input class="input" id="dateTimeInput" type="datetime-local" />
      </div>

      <!-- ì¥ì†Œ ì„ íƒ -->
      <div class="input-group">
        <label class="input-label">ì¥ì†Œ</label>
        <div class="input-row">
        <input class="input" id="placeSearch" placeholder="ì¥ì†Œ ê²€ìƒ‰ ë˜ëŠ” ì§€ë„ì—ì„œ í•€ ì§€ì •" />
          <button class="btn btn-secondary btn-sm" id="searchPlaceBtn" style="flex-shrink:0;white-space:nowrap">ê²€ìƒ‰</button>
          <button class="btn btn-primary btn-sm" id="aiSuggestBtn" style="flex-shrink:0;white-space:nowrap">AI ì¶”ì²œ</button>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ -->
      <div class="place-results hidden" id="placeResults"></div>

      <!-- ì„ íƒëœ ì¥ì†Œ í‘œì‹œ -->
      <div id="selectedPlace" class="hidden">
        <div class="card-sm flex-between">
          <div>
            <div class="font-bold text-sm" id="placeName">-</div>
            <div class="text-xs text-muted" id="placeAddr">-</div>
          </div>
          <button class="btn btn-secondary btn-sm" id="clearPlaceBtn">ë³€ê²½</button>
        </div>
        <div id="map"></div>
      </div>

      <!-- ì¹œêµ¬ ì´ˆëŒ€ -->
      <div class="input-group" style="margin-top:4px">
        <label class="input-label">ì¹œêµ¬ ì´ˆëŒ€ <span class="text-muted">(ì„ íƒ)</span></label>
        <div class="input-row" style="margin-bottom:8px">
          <input class="input" id="friendSearchInput" placeholder="ì¹œêµ¬ ê²€ìƒ‰ (ë‹‰ë„¤ì„/ì½”ë“œ)" />
        </div>
        <div id="friendGroupChips" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px"></div>
        <div class="text-xs text-muted" id="friendCount" style="margin-bottom:6px"></div>
        <div id="friendCheckList">
          <div class="text-sm text-muted">ì¹œêµ¬ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš” â†’
            <a href="/pages/friends.html" style="color:var(--accent2)">ì¹œêµ¬ ê´€ë¦¬</a>
          </div>
        </div>
      </div>

      <button class="btn btn-primary btn-block" id="createBtn" style="margin-top:8px">ì•½ì† ë§Œë“¤ê¸°</button>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item" onclick="location.href='/pages/home.html'">
        <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
      </button>
      <button class="nav-item active">
        <span class="nav-icon">â•</span><span>ì•½ì†</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/chat-list.html'">
        <span class="nav-icon">ğŸ’¬</span><span>ì±„íŒ…</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/friends.html'">
        <span class="nav-icon">ğŸ‘¥</span><span>ì¹œêµ¬</span>
      </button>
    </div>
  </nav>

  <!-- AI ì¶”ì²œ ëª¨ë‹¬ -->
  <div id="aiSuggestModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-title">AI ì¥ì†Œ ì¶”ì²œ</div>
      <div style="display:flex;gap:6px;margin-bottom:8px">
        <div class="badge badge-gray selected" data-ai-mode="origin" style="cursor:pointer">ì¶œë°œì§€ ê¸°ì¤€</div>
        <div class="badge badge-gray" data-ai-mode="home" style="cursor:pointer">ê·€ê°€ì§€ ê¸°ì¤€</div>
      </div>
      <div class="input-row" style="margin-bottom:8px">
        <select class="input" id="aiTheme" style="flex:1">
          <option value="meal">ì‹ì‚¬</option>
          <option value="drink">ìˆ </option>
          <option value="cafe">ì¹´í˜</option>
          <option value="etc">ê¸°íƒ€</option>
        </select>
        <input class="input" id="aiKeywords" placeholder="í‚¤ì›Œë“œ (ì˜ˆ: ì•„ì¬ìŠ¤íƒˆ, ì˜ˆìœì¥ì†Œ)" />
      </div>
      <div class="text-xs text-muted" id="aiPointsLabel" style="margin-bottom:6px">ì¶œë°œì§€ 2ê°œ ì´ìƒ ì…ë ¥</div>
      <div id="aiPointsList" style="display:flex;flex-direction:column;gap:8px"></div>
      <button class="btn btn-secondary btn-sm" id="aiAddPointBtn" style="margin-top:8px">ì¥ì†Œ ì¶”ê°€</button>
      <div class="section-title" style="margin-top:12px">ì¶”ì²œ ê²°ê³¼</div>
      <div id="aiResults" class="place-results" style="max-height:240px;overflow-y:auto"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-secondary btn-sm" style="flex:1" id="aiCloseBtn">ë‹«ê¸°</button>
        <button class="btn btn-primary btn-sm" style="flex:1" id="aiRunBtn">ì¶”ì²œí•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireAuth, getParam }    from '/main.js';
    import { showToast }      from '/main.js';
    import { initMap, setMarker, closeInfoWindow } from '/js/kakaomap.js';
    import { createMeeting, inviteMember, getFriends, getMeeting, updateMeeting } from '/js/db.js';
    import { WORKER_URL }     from '/js/firebase-config.js';
    import { db } from '/js/firebase-config.js';
    import { Timestamp, getDocs, collection, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    let myUid, myProfile;
    let selectedPlace = null;
    let selectedFriends = new Set();
    const meetingId = getParam('id');
    const isEdit = !!meetingId;
    let editingMeeting = null;
    let mapInstance = null;
    let mapClickBound = false;
    let searchBtnBusy = false;

    try {
      const s = await requireAuth();
      myUid = s.user.uid; myProfile = s.profile;
    } catch { location.href = '/index.html'; }

    function toLocalInputValue(date) {
      const d = date instanceof Date ? date : new Date(date);
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    if (isEdit) {
      editingMeeting = await getMeeting(meetingId);
      if (!editingMeeting) {
        showToast('ì•½ì†ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        location.href = '/pages/home.html';
      }
      if (editingMeeting.hostId !== myUid) {
        showToast('í˜¸ìŠ¤íŠ¸ë§Œ ì•½ì†ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
        location.href = `/pages/meeting.html?id=${meetingId}`;
      }

      document.getElementById('pageTitle').textContent = 'ì•½ì† ìˆ˜ì •';
      document.getElementById('createBtn').textContent = 'ì•½ì† ìˆ˜ì •';
      document.getElementById('titleInput').value = editingMeeting.title || '';
      if (editingMeeting.scheduledAt) {
        document.getElementById('dateTimeInput').value =
          toLocalInputValue(editingMeeting.scheduledAt.toDate ? editingMeeting.scheduledAt.toDate() : editingMeeting.scheduledAt);
      }
      if (editingMeeting.place?.lat && editingMeeting.place?.lng) {
        await selectPlace({
          name: editingMeeting.place.name,
          address: editingMeeting.place.address,
          lat: editingMeeting.place.lat,
          lng: editingMeeting.place.lng,
        });
      }

      // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ì´ˆëŒ€ ë³€ê²½ì„ ìˆ¨ê¹€
      document.querySelector('[id="friendCheckList"]')?.closest('.input-group')?.classList.add('hidden');
    }

    // ê¸°ë³¸ ë‚ ì§œ: 1ì‹œê°„ ë’¤ (ì‹ ê·œ ìƒì„± ì‹œ)
    if (!isEdit) {
      const defaultDt = new Date(Date.now() + 3600_000);
      defaultDt.setSeconds(0, 0);
      document.getElementById('dateTimeInput').value =
        defaultDt.toISOString().slice(0, 16);
    }

    // ì¥ì†Œ ê²€ìƒ‰
    document.getElementById('searchPlaceBtn').addEventListener('click', () => {
      if (searchBtnBusy) return;
      searchBtnBusy = true;
      doSearch().finally(() => { searchBtnBusy = false; });
    });
    document.getElementById('placeSearch').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        if (searchBtnBusy) return;
        searchBtnBusy = true;
        doSearch().finally(() => { searchBtnBusy = false; });
      }
    });

    async function ensureMap(lat, lng, level = 3) {
      if (!mapInstance) {
        mapInstance = await initMap('map', { lat, lng, level });
      } else {
        mapInstance.setCenter(new kakao.maps.LatLng(lat, lng));
        mapInstance.setLevel(level);
        mapInstance.relayout();
      }
      // hidden ìƒíƒœì—ì„œ í‘œì‹œë  ë•Œ ëŒ€ë¹„ (ë‹¤ìŒ í”„ë ˆì„ì—ì„œ relayout)
      requestAnimationFrame(() => {
        if (!mapInstance) return;
        mapInstance.relayout();
        mapInstance.setCenter(new kakao.maps.LatLng(lat, lng));
      });
      return mapInstance;
    }

    async function enablePinPick() {
      closeInfoWindow();
      document.getElementById('placeName').textContent = 'ì§€ë„ì—ì„œ ì§€ì •';
      document.getElementById('placeAddr').textContent = 'ì§€ë„ë¥¼ ëˆŒëŸ¬ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”';
      document.getElementById('selectedPlace').classList.remove('hidden');
      await new Promise(requestAnimationFrame);
      const baseLat = selectedPlace?.lat || 37.5665;
      const baseLng = selectedPlace?.lng || 126.978;
      await ensureMap(baseLat, baseLng, 4);
      document.getElementById('placeResults').classList.add('hidden');
      showToast('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ íƒ­í•´ í•€ì„ ì„¤ì •í•˜ì„¸ìš”', 'info');

      if (!mapClickBound) {
        kakao.maps.event.addListener(mapInstance, 'click', (mouseEvent) => {
          const latlng = mouseEvent.latLng;
          const lat = latlng.getLat();
          const lng = latlng.getLng();
          selectedPlace = {
            name: 'ì§€ë„ì—ì„œ ì§€ì •',
            address: `${lat.toFixed(5)}, ${lng.toFixed(5)}`,
            lat,
            lng,
          };
          document.getElementById('placeName').textContent = selectedPlace.name;
          document.getElementById('placeAddr').textContent = selectedPlace.address;
          document.getElementById('selectedPlace').classList.remove('hidden');
          setMarker(lat, lng, '');
        });
        mapClickBound = true;
      }
    }

    async function doSearch() {
      const q = document.getElementById('placeSearch').value.trim();
      if (!q) {
        await enablePinPick();
        return;
      }
      document.getElementById('searchPlaceBtn').textContent = '...';
      try {
        const res = await fetch(`${WORKER_URL}/api/search-places?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        renderPlaceResults(data.results || []);
      } catch (e) {
        showToast('ì¥ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨: ' + e.message, 'error');
      } finally {
        document.getElementById('searchPlaceBtn').textContent = 'ê²€ìƒ‰';
      }
    }

    function renderPlaceResults(results) {
      const el = document.getElementById('placeResults');
      if (!results.length) {
        el.innerHTML = '<div class="text-sm text-muted" style="padding:12px">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        el.classList.remove('hidden');
        return;
      }
      el.classList.remove('hidden');
      el.innerHTML = results.slice(0, 8).map((r, i) => `
        <div class="place-result-item" data-i="${i}">
          <div class="place-result-info">
            <div class="place-result-name">${r.name}</div>
            <div class="place-result-addr">${r.address}</div>
          </div>
        </div>`).join('');

      el.querySelectorAll('.place-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const idx = parseInt(item.dataset.i);
          selectPlace(results[idx]);
          el.classList.add('hidden');
        });
      });
    }

    async function selectPlace(place) {
      selectedPlace = place;
      document.getElementById('placeName').textContent = place.name;
      document.getElementById('placeAddr').textContent = place.address;
      document.getElementById('selectedPlace').classList.remove('hidden');
      await new Promise(requestAnimationFrame);
      await ensureMap(place.lat, place.lng, 3);
      setMarker(place.lat, place.lng, place.name);
    }

    document.getElementById('clearPlaceBtn').addEventListener('click', async () => {
      selectedPlace = null;
      document.getElementById('selectedPlace').classList.add('hidden');
      document.getElementById('placeSearch').value = '';
      await enablePinPick();
    });

    // ===== AI ì¶”ì²œ ëª¨ë‹¬ =====
    const aiBtn = document.getElementById('aiSuggestBtn');
    const aiModal = document.getElementById('aiSuggestModal');
    const aiCloseBtn = document.getElementById('aiCloseBtn');
    const aiRunBtn = document.getElementById('aiRunBtn');
    const aiModeTabs = document.querySelectorAll('[data-ai-mode]');
    const aiThemeSelect = document.getElementById('aiTheme');
    const aiKeywords = document.getElementById('aiKeywords');
    const aiPointsList = document.getElementById('aiPointsList');
    const aiPointsLabel = document.getElementById('aiPointsLabel');
    const aiAddPointBtn = document.getElementById('aiAddPointBtn');
    const aiResults = document.getElementById('aiResults');
    let aiMode = 'origin'; // origin or home

    function addPointRow(initial = '') {
      const id = `p_${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
      const row = document.createElement('div');
      row.className = 'card-sm';
      row.dataset.pid = id;
      row.innerHTML = `
        <div class="input-row">
          <input class="input" placeholder="${aiMode === 'home' ? 'ê·€ê°€ì§€ ì…ë ¥' : 'ì¶œë°œì§€ ì…ë ¥'}" value="${initial}">
          <button class="btn btn-secondary btn-sm">ê²€ìƒ‰</button>
          <button class="btn btn-secondary btn-sm">ì‚­ì œ</button>
        </div>
        <div class="text-xs text-muted" style="margin-top:6px" data-selected></div>
        <div class="place-results hidden" data-results></div>
      `;
      const [inputEl, searchBtn, delBtn] = row.querySelectorAll('input,button');
      const selectedEl = row.querySelector('[data-selected]');
      const resultsEl = row.querySelector('[data-results]');

      async function doSearch() {
        const q = inputEl.value.trim();
        if (!q) { showToast('ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
        searchBtn.textContent = '...';
        try {
          const res = await fetch(`${WORKER_URL}/api/search-places?q=${encodeURIComponent(q)}`);
          const data = await res.json();
          if (data.error) throw new Error(data.error);
          const results = data.results || [];
          if (!results.length) {
            resultsEl.innerHTML = '<div class="text-sm text-muted" style="padding:8px">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            resultsEl.classList.remove('hidden');
            return;
          }
          resultsEl.innerHTML = results.slice(0, 6).map((r, i) => `
            <div class="place-result-item" data-i="${i}">
              <div class="place-result-info">
                <div class="place-result-name">${r.name}</div>
                <div class="place-result-addr">${r.address}</div>
              </div>
            </div>`).join('');
          resultsEl.classList.remove('hidden');
          resultsEl.querySelectorAll('.place-result-item').forEach(item => {
            item.addEventListener('click', () => {
              const idx = parseInt(item.dataset.i, 10);
              const r = results[idx];
              row.dataset.lat = r.lat;
              row.dataset.lng = r.lng;
              row.dataset.name = r.name;
              row.dataset.address = r.address;
              selectedEl.textContent = `ì„ íƒë¨: ${r.name} Â· ${r.address}`;
              resultsEl.classList.add('hidden');
            });
          });
        } catch (e) {
          showToast('ê²€ìƒ‰ ì‹¤íŒ¨: ' + e.message, 'error');
        } finally {
          searchBtn.textContent = 'ê²€ìƒ‰';
        }
      }

      searchBtn.addEventListener('click', doSearch);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') doSearch();
      });
      delBtn.addEventListener('click', () => row.remove());
      aiPointsList.appendChild(row);
    }

    function getPoints() {
      const rows = [...aiPointsList.querySelectorAll('[data-pid]')];
      return rows.map(r => ({
        lat: parseFloat(r.dataset.lat),
        lng: parseFloat(r.dataset.lng),
        name: r.dataset.name,
        address: r.dataset.address,
      })).filter(p => Number.isFinite(p.lat) && Number.isFinite(p.lng));
    }

    function setMode(mode) {
      aiMode = mode;
      aiModeTabs.forEach(t => t.classList.toggle('selected', t.dataset.aiMode === mode));
      aiPointsLabel.textContent = (aiMode === 'home' ? 'ê·€ê°€ì§€' : 'ì¶œë°œì§€') + ' 2ê°œ ì´ìƒ ì…ë ¥';
      aiPointsList.querySelectorAll('input').forEach(i => {
        i.placeholder = aiMode === 'home' ? 'ê·€ê°€ì§€ ì…ë ¥' : 'ì¶œë°œì§€ ì…ë ¥';
      });
    }

    aiModeTabs.forEach(t => t.addEventListener('click', () => setMode(t.dataset.aiMode)));
    aiBtn.addEventListener('click', () => {
      aiResults.innerHTML = '';
      if (!aiPointsList.children.length) {
        addPointRow();
        addPointRow();
      }
      aiModal.classList.remove('hidden');
    });
    aiCloseBtn.addEventListener('click', () => aiModal.classList.add('hidden'));
    aiAddPointBtn.addEventListener('click', () => addPointRow());

    function themeQuery(theme, keywords) {
      const base = {
        meal: 'ë§›ì§‘ ì‹ì‚¬',
        drink: 'ìˆ ì§‘ ë°”',
        cafe: 'ì¹´í˜ ë””ì €íŠ¸',
        etc: '',
      }[theme] || '';
      return `${base} ${keywords || ''}`.trim();
    }

    async function recommendPlaces() {
      const points = getPoints();
      if (points.length < 2) {
        const label = aiMode === 'home' ? 'ê·€ê°€ì§€' : 'ì¶œë°œì§€';
        showToast(`${label} 2ê°œ ì´ìƒì„ ì„ íƒí•˜ì„¸ìš”`, 'error');
        return;
      }
      if (aiPointsList.querySelectorAll('[data-pid]').length > points.length) {
        showToast('ì…ë ¥í•œ ì¥ì†Œë¥¼ ê²€ìƒ‰í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
        return;
      }
      const centroid = points.reduce((acc, p) => ({ lat: acc.lat + p.lat, lng: acc.lng + p.lng }), { lat: 0, lng: 0 });
      centroid.lat /= points.length;
      centroid.lng /= points.length;

      const theme = aiThemeSelect.value;
      const keywords = aiKeywords.value.trim();
      const baseQuery = themeQuery(theme, keywords);
      if (!baseQuery) { showToast('í…Œë§ˆ/í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }

      aiRunBtn.disabled = true;
      aiRunBtn.textContent = 'ì¶”ì²œ ì¤‘...';
      aiResults.innerHTML = '';

      try {
        const queries = [
          { q: baseQuery, radius: 3000, label: baseQuery },
          { q: themeQuery(theme, ''), radius: 3000, label: themeQuery(theme, '') },
          { q: keywords, radius: 3000, label: keywords },
          { q: baseQuery, radius: 5000, label: baseQuery },
          { q: themeQuery(theme, ''), radius: 5000, label: themeQuery(theme, '') },
          { q: keywords, radius: 5000, label: keywords },
        ].filter(x => x.q);

        let candidates = [];
        let usedLabel = '';
        for (const q of queries) {
          const res = await fetch(`${WORKER_URL}/api/search-places?q=${encodeURIComponent(q.q)}&lat=${centroid.lat}&lng=${centroid.lng}&radius=${q.radius}`);
          const data = await res.json();
          if (data.error) {
            aiResults.innerHTML = `<div class="text-sm text-muted">ê²€ìƒ‰ ì‹¤íŒ¨: ${data.error}</div>`;
            return;
          }
          candidates = (data.results || []).slice(0, 8);
          if (candidates.length) { usedLabel = q.label; break; }
        }

        if (!candidates.length) {
          aiResults.innerHTML = `
            <div class="text-sm text-muted">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
            <div class="text-xs text-muted" style="margin-top:6px">ê²€ìƒ‰ì–´ë¥¼ ë‹¨ìˆœí•˜ê²Œ ì¤„ì—¬ë³´ì„¸ìš”.</div>`;
          return;
        }

        const haversineKm = (a, b) => {
          const toRad = (v) => (v * Math.PI) / 180;
          const R = 6371;
          const dLat = toRad(b.lat - a.lat);
          const dLng = toRad(b.lng - a.lng);
          const lat1 = toRad(a.lat);
          const lat2 = toRad(b.lat);
          const x = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
          return 2 * R * Math.asin(Math.sqrt(x));
        };

        const scored = [];
        for (const c of candidates) {
          const times = [];
          for (const p of points.slice(0, 5)) {
            try {
              const etaRes = await fetch(`${WORKER_URL}/api/transit-eta?origin_lat=${p.lat}&origin_lng=${p.lng}&dest_lat=${c.lat}&dest_lng=${c.lng}`);
              const eta = await etaRes.json();
              if (eta?.minutes) {
                times.push(eta.minutes);
                continue;
              }
            } catch {}
            // ETA ì‹¤íŒ¨ ì‹œ ì§ì„ ê±°ë¦¬ ê¸°ë°˜ ê·¼ì‚¬ (ëŒ€ì¤‘êµí†µ í‰ê·  ì†ë„ 20km/h)
            const km = haversineKm(p, c);
            const minutes = Math.max(5, Math.round((km / 20) * 60));
            times.push(minutes);
          }
          if (!times.length) continue;
          const avg = times.reduce((a,b)=>a+b,0) / times.length;
          const std = Math.sqrt(times.reduce((a,b)=>a+(b-avg)*(b-avg),0) / times.length);
          const score = avg + std * 0.7;
          scored.push({ c, avg, std, score, min: Math.min(...times), max: Math.max(...times) });
        }
        scored.sort((a,b)=>a.score-b.score);

        const defaultCount = 3;
        const themeLabel = {
          meal: 'ì‹ì‚¬',
          drink: 'ìˆ ',
          cafe: 'ì¹´í˜',
          etc: 'ëª¨ì„',
        }[theme] || 'ëª¨ì„';
        const descLine = keywords ? `${themeLabel} Â· ${keywords}` : themeLabel;

        const renderItems = (list) => list.map(s => `
          <div class="place-result-item" data-lat="${s.c.lat}" data-lng="${s.c.lng}" data-name="${s.c.name}" data-addr="${s.c.address}">
            <div class="place-result-info">
              <div class="place-result-name">${s.c.name}</div>
              <div class="place-result-addr">${s.c.address}</div>
              <div class="text-xs text-muted">ì´ë™ì‹œê°„ ë²”ìœ„ ${s.min}-${s.max}ë¶„</div>
              <div class="text-xs text-muted">${s.c.category || descLine}</div>
            </div>
          </div>`).join('');
        const top = scored.slice(0, defaultCount);
        const rest = scored.slice(defaultCount);
        aiResults.innerHTML = `
          <div class="text-xs text-muted" style="margin-bottom:6px">ê²€ìƒ‰ì–´: ${usedLabel || baseQuery}</div>
          ${renderItems(top)}
          ${rest.length ? '<button class="btn btn-secondary btn-sm" id="aiMoreBtn" style="margin-top:6px;width:100%">ë”ë³´ê¸°</button>' : ''}
        `;
        if (!scored.length) {
          aiResults.innerHTML = '<div class="text-sm text-muted">ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        }

        function bindResultClicks() {
          aiResults.querySelectorAll('.place-result-item').forEach(item => {
            item.addEventListener('click', async () => {
              const place = {
                name: item.dataset.name,
                address: item.dataset.addr,
                lat: parseFloat(item.dataset.lat),
                lng: parseFloat(item.dataset.lng),
              };
              await selectPlace(place);
              aiModal.classList.add('hidden');
              showToast('ì¶”ì²œ ì¥ì†Œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            });
          });
        }

        bindResultClicks();
        if (rest.length) {
          document.getElementById('aiMoreBtn')?.addEventListener('click', () => {
            document.getElementById('aiMoreBtn')?.remove();
            aiResults.innerHTML += renderItems(rest);
            bindResultClicks();
          });
        }
      } catch (e) {
        showToast('ì¶”ì²œ ì‹¤íŒ¨: ' + e.message, 'error');
      } finally {
        aiRunBtn.disabled = false;
        aiRunBtn.textContent = 'ì¶”ì²œí•˜ê¸°';
      }
    }

    aiRunBtn.addEventListener('click', recommendPlaces);

    // ì¹œêµ¬ ëª©ë¡ ë¡œë“œ (ê²€ìƒ‰/ê·¸ë£¹ í•„í„°)
    const friendList = document.getElementById('friendCheckList');
    const friendSearchInput = document.getElementById('friendSearchInput');
    const friendGroupChips  = document.getElementById('friendGroupChips');
    const friendCountEl     = document.getElementById('friendCount');
    const friendGroups = Array.isArray(myProfile.friendGroups) ? myProfile.friendGroups : [];
    let selectedGroupId = 'all';
    let allFriends = await getFriends(myProfile.friends || []);

    function renderGroupChips() {
      if (!friendGroups.length) {
        friendGroupChips.innerHTML = '<div class="badge badge-gray selected" data-gid="all" style="cursor:pointer">ì „ì²´</div>';
        friendGroupChips.querySelector('[data-gid="all"]').addEventListener('click', () => {
          selectedGroupId = 'all';
          renderGroupChips();
          renderFriendList();
        });
        return;
      }
      friendGroupChips.innerHTML = [
        `<div class="badge badge-gray ${selectedGroupId === 'all' ? 'selected' : ''}" data-gid="all" style="cursor:pointer">ì „ì²´</div>`,
        ...friendGroups.map(g => `
          <div class="badge badge-gray ${selectedGroupId === g.id ? 'selected' : ''}" data-gid="${g.id}" style="cursor:pointer">
            ${g.name} <span class="text-xs text-muted">(${(g.memberUids || []).length})</span>
          </div>
        `),
      ].join('');
      friendGroupChips.querySelectorAll('[data-gid]').forEach(chip => {
        chip.addEventListener('click', () => {
          selectedGroupId = chip.dataset.gid;
          renderGroupChips();
          renderFriendList();
        });
      });
    }

    function safeImg(url) {
      return (url || '').replace(/^http:\/\//i, 'https://');
    }

    function renderFriendList() {
      const q = friendSearchInput.value.trim().toLowerCase();
      let filtered = allFriends;
      if (selectedGroupId !== 'all') {
        const group = friendGroups.find(g => g.id === selectedGroupId);
        const set = new Set(group?.memberUids || []);
        filtered = filtered.filter(f => set.has(f.uid));
      }
      if (q) {
        filtered = filtered.filter(f =>
          (f.nickname || '').toLowerCase().includes(q) ||
          (f.inviteCode || '').toLowerCase().includes(q)
        );
      }
      friendCountEl.textContent = `(${filtered.length}/${allFriends.length})`;

      if (!filtered.length) {
        friendList.innerHTML = `
          <div class="text-sm text-muted">
            ${allFriends.length ? 'ì¡°ê±´ì— ë§ëŠ” ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì¹œêµ¬ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš” â†’ '}
            ${allFriends.length ? '' : '<a href="/pages/friends.html" style="color:var(--accent2)">ì¹œêµ¬ ê´€ë¦¬</a>'}
          </div>`;
        return;
      }
      friendList.innerHTML = filtered.map(f => `
        <div class="friend-check-item ${selectedFriends.has(f.uid) ? 'selected' : ''}" data-uid="${f.uid}">
          <div class="avatar">${f.profileImg ? `<img src="${safeImg(f.profileImg)}">` : f.nickname?.[0] || '?'}</div>
          <span class="text-sm font-bold">${f.nickname}</span>
        </div>`).join('');

      friendList.querySelectorAll('.friend-check-item').forEach(item => {
        item.addEventListener('click', () => {
          const uid = item.dataset.uid;
          if (selectedFriends.has(uid)) {
            selectedFriends.delete(uid);
            item.classList.remove('selected');
          } else {
            selectedFriends.add(uid);
            item.classList.add('selected');
          }
        });
      });
    }

    friendSearchInput.addEventListener('input', renderFriendList);
    renderGroupChips();
    renderFriendList();

    // ì•½ì† ë§Œë“¤ê¸°
    document.getElementById('createBtn').addEventListener('click', async () => {
      const title    = document.getElementById('titleInput').value.trim();
      const dateStr  = document.getElementById('dateTimeInput').value;

      if (!title)       { showToast('ì•½ì† ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
      if (!selectedPlace) { showToast('ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
      if (!dateStr)     { showToast('ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

      const createBtn = document.getElementById('createBtn');
      createBtn.disabled = true;
      createBtn.textContent = isEdit ? 'ìˆ˜ì • ì¤‘...' : 'ë§Œë“œëŠ” ì¤‘...';

      try {
        const scheduledAt = Timestamp.fromDate(new Date(dateStr));

        if (isEdit) {
          await updateMeeting(meetingId, {
            title,
            place: { name: selectedPlace.name, address: selectedPlace.address, lat: selectedPlace.lat, lng: selectedPlace.lng },
            scheduledAt,
          });

          // userMeetings ì¸ë±ìŠ¤ ê°±ì‹ 
          const memberSnap = await getDocs(collection(db, 'meetings', meetingId, 'members'));
          await Promise.all(memberSnap.docs.map(d => updateDoc(
            doc(db, 'userMeetings', `${d.id}_${meetingId}`),
            {
              title,
              scheduledAt,
              placeName: selectedPlace.name,
              placeAddress: selectedPlace.address,
            },
          ).catch(() => {})));

          showToast('ì•½ì†ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          location.href = `/pages/meeting.html?id=${meetingId}`;
          return;
        }

        const newMeetingId = await createMeeting({
          title, hostId: myUid,
          place: { name: selectedPlace.name, address: selectedPlace.address, lat: selectedPlace.lat, lng: selectedPlace.lng },
          scheduledAt,
        });

        // í˜¸ìŠ¤íŠ¸ë¥¼ ë©¤ë²„ë¡œ ì¶”ê°€
        await inviteMember(newMeetingId, myUid, myProfile.nickname, myProfile.profileImg, {
          title,
          status: 'pending',
          scheduledAt,
          place: { name: selectedPlace.name, address: selectedPlace.address },
        });
        // ìˆ˜ë½ ìƒíƒœë¡œ ë³€ê²½
        const { setMember } = await import('/js/db.js');
        await setMember(newMeetingId, myUid, { status: 'accepted' });

        // ì´ˆëŒ€ëœ ì¹œêµ¬ë“¤ ì¶”ê°€ + FCM ì•Œë¦¼
        await Promise.all([...selectedFriends].map(async (uid) => {
          const f = friends.find(fr => fr.uid === uid);
          if (!f) return;
          await inviteMember(newMeetingId, uid, f.nickname, f.profileImg, {
            title,
            status: 'pending',
            scheduledAt,
            place: { name: selectedPlace.name, address: selectedPlace.address },
          });
          // FCM ì•Œë¦¼ (fcmTokenì´ ìˆì„ ë•Œë§Œ)
          if (f.fcmToken) {
            await fetch(`${WORKER_URL}/api/notify`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                token: f.fcmToken,
                title: 'ğŸ“… ì•½ì† ì´ˆëŒ€',
                body:  `${myProfile.nickname}ë‹˜ì´ "${title}" ì•½ì†ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤`,
                data:  { meetingId: newMeetingId, url: `/pages/meeting.html?id=${newMeetingId}` },
              }),
            }).catch(console.warn);
          }
        }));

        showToast('ì•½ì†ì´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤!', 'success');
        location.href = `/pages/meeting.html?id=${newMeetingId}`;
      } catch (e) {
        console.error(e);
        showToast((isEdit ? 'ì•½ì† ìˆ˜ì • ì‹¤íŒ¨: ' : 'ì•½ì† ë§Œë“¤ê¸° ì‹¤íŒ¨: ') + e.message, 'error');
        createBtn.disabled = false;
        createBtn.textContent = isEdit ? 'ì•½ì† ìˆ˜ì •' : 'ì•½ì† ë§Œë“¤ê¸°';
      }
    });
  </script>
</body>
</html>

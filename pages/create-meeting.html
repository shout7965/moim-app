<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì•½ì† ë§Œë“¤ê¸° - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    #map { height: 220px; border-radius: var(--radius); overflow: hidden; }
    .friend-check-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: var(--radius-sm);
      border: 2px solid var(--border); cursor: pointer;
      transition: border-color 0.15s;
    }
    .friend-check-item.selected { border-color: var(--accent); background: rgba(108,99,255,0.08); }
    .friend-check-item .avatar { flex-shrink: 0; }
    .place-results {
      max-height: 200px; overflow-y: auto;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      background: var(--bg3);
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="page-header">
      <button class="btn-icon-round" onclick="history.back()">â†</button>
      <h1 id="pageTitle">ì•½ì† ë§Œë“¤ê¸°</h1>
    </div>

    <div class="page-content pb-safe">
      <!-- ì•½ì† ì œëª© -->
      <div class="input-group">
        <label class="input-label">ì•½ì† ì´ë¦„</label>
        <input class="input" id="titleInput" placeholder="ì˜ˆ: ê°•ë‚¨ì—­ ì ì‹¬" maxlength="30" />
      </div>

      <!-- ë‚ ì§œ/ì‹œê°„ -->
      <div class="input-group">
        <label class="input-label">ë‚ ì§œ & ì‹œê°„</label>
        <input class="input" id="dateTimeInput" type="datetime-local" />
      </div>

      <!-- ì¥ì†Œ ì„ íƒ -->
      <div class="input-group">
        <label class="input-label">ì¥ì†Œ</label>
        <div class="input-row">
          <input class="input" id="placeSearch" placeholder="ì¥ì†Œ ê²€ìƒ‰..." />
          <button class="btn btn-secondary btn-sm" id="searchPlaceBtn" style="flex-shrink:0;white-space:nowrap">ê²€ìƒ‰</button>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ -->
      <div class="place-results hidden" id="placeResults"></div>

      <!-- ì„ íƒëœ ì¥ì†Œ í‘œì‹œ -->
      <div id="selectedPlace" class="hidden">
        <div class="card-sm flex-between">
          <div>
            <div class="font-bold text-sm" id="placeName">-</div>
            <div class="text-xs text-muted" id="placeAddr">-</div>
          </div>
          <button class="btn btn-secondary btn-sm" id="clearPlaceBtn">ë³€ê²½</button>
        </div>
        <div id="map"></div>
      </div>

      <!-- ì¹œêµ¬ ì´ˆëŒ€ -->
      <div class="input-group" style="margin-top:4px">
        <label class="input-label">ì¹œêµ¬ ì´ˆëŒ€ <span class="text-muted">(ì„ íƒ)</span></label>
        <div id="friendCheckList">
          <div class="text-sm text-muted">ì¹œêµ¬ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš” â†’
            <a href="/pages/friends.html" style="color:var(--accent2)">ì¹œêµ¬ ê´€ë¦¬</a>
          </div>
        </div>
      </div>

      <button class="btn btn-primary btn-block" id="createBtn" style="margin-top:8px">ì•½ì† ë§Œë“¤ê¸°</button>
    </div>
  </div>

  <script type="module">
    import { requireAuth, getParam }    from '/main.js';
    import { showToast }      from '/main.js';
    import { initMap, setMarker } from '/js/kakaomap.js';
    import { createMeeting, inviteMember, getFriends, getMeeting, updateMeeting } from '/js/db.js';
    import { WORKER_URL }     from '/js/firebase-config.js';
    import { db } from '/js/firebase-config.js';
    import { Timestamp, getDocs, collection, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    let myUid, myProfile;
    let selectedPlace = null;
    let selectedFriends = new Set();
    const meetingId = getParam('id');
    const isEdit = !!meetingId;
    let editingMeeting = null;

    try {
      const s = await requireAuth();
      myUid = s.user.uid; myProfile = s.profile;
    } catch { location.href = '/index.html'; }

    function toLocalInputValue(date) {
      const d = date instanceof Date ? date : new Date(date);
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    if (isEdit) {
      editingMeeting = await getMeeting(meetingId);
      if (!editingMeeting) {
        showToast('ì•½ì†ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
        location.href = '/pages/home.html';
      }
      if (editingMeeting.hostId !== myUid) {
        showToast('í˜¸ìŠ¤íŠ¸ë§Œ ì•½ì†ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
        location.href = `/pages/meeting.html?id=${meetingId}`;
      }

      document.getElementById('pageTitle').textContent = 'ì•½ì† ìˆ˜ì •';
      document.getElementById('createBtn').textContent = 'ì•½ì† ìˆ˜ì •';
      document.getElementById('titleInput').value = editingMeeting.title || '';
      if (editingMeeting.scheduledAt) {
        document.getElementById('dateTimeInput').value =
          toLocalInputValue(editingMeeting.scheduledAt.toDate ? editingMeeting.scheduledAt.toDate() : editingMeeting.scheduledAt);
      }
      if (editingMeeting.place?.lat && editingMeeting.place?.lng) {
        await selectPlace({
          name: editingMeeting.place.name,
          address: editingMeeting.place.address,
          lat: editingMeeting.place.lat,
          lng: editingMeeting.place.lng,
        });
      }

      // í¸ì§‘ ëª¨ë“œì—ì„œëŠ” ì´ˆëŒ€ ë³€ê²½ì„ ìˆ¨ê¹€
      document.querySelector('[id="friendCheckList"]')?.closest('.input-group')?.classList.add('hidden');
    }

    // ê¸°ë³¸ ë‚ ì§œ: 1ì‹œê°„ ë’¤ (ì‹ ê·œ ìƒì„± ì‹œ)
    if (!isEdit) {
      const defaultDt = new Date(Date.now() + 3600_000);
      defaultDt.setSeconds(0, 0);
      document.getElementById('dateTimeInput').value =
        defaultDt.toISOString().slice(0, 16);
    }

    // ì¥ì†Œ ê²€ìƒ‰
    document.getElementById('searchPlaceBtn').addEventListener('click', doSearch);
    document.getElementById('placeSearch').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

    async function doSearch() {
      const q = document.getElementById('placeSearch').value.trim();
      if (!q) return;
      document.getElementById('searchPlaceBtn').textContent = '...';
      try {
        const res = await fetch(`${WORKER_URL}/api/search-places?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        renderPlaceResults(data.results || []);
      } catch (e) {
        showToast('ì¥ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨: ' + e.message, 'error');
      } finally {
        document.getElementById('searchPlaceBtn').textContent = 'ê²€ìƒ‰';
      }
    }

    function renderPlaceResults(results) {
      const el = document.getElementById('placeResults');
      if (!results.length) {
        el.innerHTML = '<div class="text-sm text-muted" style="padding:12px">ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        el.classList.remove('hidden');
        return;
      }
      el.classList.remove('hidden');
      el.innerHTML = results.slice(0, 8).map((r, i) => `
        <div class="place-result-item" data-i="${i}">
          <div class="place-result-info">
            <div class="place-result-name">${r.name}</div>
            <div class="place-result-addr">${r.address}</div>
          </div>
        </div>`).join('');

      el.querySelectorAll('.place-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const idx = parseInt(item.dataset.i);
          selectPlace(results[idx]);
          el.classList.add('hidden');
        });
      });
    }

    async function selectPlace(place) {
      selectedPlace = place;
      document.getElementById('placeName').textContent = place.name;
      document.getElementById('placeAddr').textContent = place.address;
      document.getElementById('selectedPlace').classList.remove('hidden');
      await initMap('map', { lat: place.lat, lng: place.lng, level: 3 });
      setMarker(place.lat, place.lng, place.name);
    }

    document.getElementById('clearPlaceBtn').addEventListener('click', () => {
      selectedPlace = null;
      document.getElementById('selectedPlace').classList.add('hidden');
      document.getElementById('placeSearch').value = '';
    });

    // ì¹œêµ¬ ëª©ë¡ ë¡œë“œ
    const friends = await getFriends(myProfile.friends || []);
    const friendList = document.getElementById('friendCheckList');
    if (friends.length) {
      friendList.innerHTML = friends.map(f => `
        <div class="friend-check-item" data-uid="${f.uid}">
          <div class="avatar">${f.profileImg ? `<img src="${f.profileImg}">` : f.nickname[0]}</div>
          <span class="text-sm font-bold">${f.nickname}</span>
        </div>`).join('');

      friendList.querySelectorAll('.friend-check-item').forEach(item => {
        item.addEventListener('click', () => {
          const uid = item.dataset.uid;
          if (selectedFriends.has(uid)) {
            selectedFriends.delete(uid);
            item.classList.remove('selected');
          } else {
            selectedFriends.add(uid);
            item.classList.add('selected');
          }
        });
      });
    }

    // ì•½ì† ë§Œë“¤ê¸°
    document.getElementById('createBtn').addEventListener('click', async () => {
      const title    = document.getElementById('titleInput').value.trim();
      const dateStr  = document.getElementById('dateTimeInput').value;

      if (!title)       { showToast('ì•½ì† ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
      if (!selectedPlace) { showToast('ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
      if (!dateStr)     { showToast('ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

      const createBtn = document.getElementById('createBtn');
      createBtn.disabled = true;
      createBtn.textContent = isEdit ? 'ìˆ˜ì • ì¤‘...' : 'ë§Œë“œëŠ” ì¤‘...';

      try {
        const scheduledAt = Timestamp.fromDate(new Date(dateStr));

        if (isEdit) {
          await updateMeeting(meetingId, {
            title,
            place: { name: selectedPlace.name, address: selectedPlace.address, lat: selectedPlace.lat, lng: selectedPlace.lng },
            scheduledAt,
          });

          // userMeetings ì¸ë±ìŠ¤ ê°±ì‹ 
          const memberSnap = await getDocs(collection(db, 'meetings', meetingId, 'members'));
          await Promise.all(memberSnap.docs.map(d => updateDoc(
            doc(db, 'userMeetings', `${d.id}_${meetingId}`),
            {
              title,
              scheduledAt,
              placeName: selectedPlace.name,
              placeAddress: selectedPlace.address,
            },
          ).catch(() => {})));

          showToast('ì•½ì†ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          location.href = `/pages/meeting.html?id=${meetingId}`;
          return;
        }

        const newMeetingId = await createMeeting({
          title, hostId: myUid,
          place: { name: selectedPlace.name, address: selectedPlace.address, lat: selectedPlace.lat, lng: selectedPlace.lng },
          scheduledAt,
        });

        // í˜¸ìŠ¤íŠ¸ë¥¼ ë©¤ë²„ë¡œ ì¶”ê°€
        await inviteMember(newMeetingId, myUid, myProfile.nickname, myProfile.profileImg, {
          title,
          status: 'pending',
          scheduledAt,
          place: { name: selectedPlace.name, address: selectedPlace.address },
        });
        // ìˆ˜ë½ ìƒíƒœë¡œ ë³€ê²½
        const { setMember } = await import('/js/db.js');
        await setMember(newMeetingId, myUid, { status: 'accepted' });

        // ì´ˆëŒ€ëœ ì¹œêµ¬ë“¤ ì¶”ê°€ + FCM ì•Œë¦¼
        await Promise.all([...selectedFriends].map(async (uid) => {
          const f = friends.find(fr => fr.uid === uid);
          if (!f) return;
          await inviteMember(newMeetingId, uid, f.nickname, f.profileImg, {
            title,
            status: 'pending',
            scheduledAt,
            place: { name: selectedPlace.name, address: selectedPlace.address },
          });
          // FCM ì•Œë¦¼ (fcmTokenì´ ìˆì„ ë•Œë§Œ)
          if (f.fcmToken) {
            await fetch(`${WORKER_URL}/api/notify`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                token: f.fcmToken,
                title: 'ğŸ“… ì•½ì† ì´ˆëŒ€',
                body:  `${myProfile.nickname}ë‹˜ì´ "${title}" ì•½ì†ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤`,
                data:  { meetingId: newMeetingId, url: `/pages/meeting.html?id=${newMeetingId}` },
              }),
            }).catch(console.warn);
          }
        }));

        showToast('ì•½ì†ì´ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤!', 'success');
        location.href = `/pages/meeting.html?id=${newMeetingId}`;
      } catch (e) {
        console.error(e);
        showToast((isEdit ? 'ì•½ì† ìˆ˜ì • ì‹¤íŒ¨: ' : 'ì•½ì† ë§Œë“¤ê¸° ì‹¤íŒ¨: ') + e.message, 'error');
        createBtn.disabled = false;
        createBtn.textContent = isEdit ? 'ì•½ì† ìˆ˜ì •' : 'ì•½ì† ë§Œë“¤ê¸°';
      }
    });
  </script>
</body>
</html>

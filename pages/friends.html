<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì¹œêµ¬ - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="page page-with-nav">
    <div class="page-header">
      <h1>ì¹œêµ¬</h1>
      <div id="profileArea" style="display:flex;align-items:center;gap:8px">
        <div class="avatar" id="myAvatar">?</div>
        <button class="btn btn-secondary btn-sm" id="logoutBtn" style="display:none">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <div class="page-content">
      <!-- ë‚´ ì´ˆëŒ€ì½”ë“œ -->
      <div class="section-title">ë‚´ ì´ˆëŒ€ì½”ë“œ</div>
      <div class="invite-code-box">
        <div class="invite-code-value" id="myCode">------</div>
        <p class="text-xs text-muted" style="text-align:center">ì¹œêµ¬ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</p>
        <div style="display:flex;gap:8px;width:100%">
          <button class="btn btn-secondary" style="flex:1" id="copyCodeBtn">ë³µì‚¬</button>
          <button class="btn btn-primary" style="flex:1" id="shareCodeBtn">ê³µìœ </button>
        </div>
      </div>

      <!-- ì¹œêµ¬ ì¶”ê°€ -->
      <div class="section-title" style="margin-top:8px">ì¹œêµ¬ ì¶”ê°€</div>
      <div class="card-sm">
        <div class="input-row">
          <input class="input" id="codeInput" placeholder="ì¹œêµ¬ ì´ˆëŒ€ì½”ë“œ 6ìë¦¬" maxlength="6"
            style="text-transform:uppercase;letter-spacing:0.12em;font-family:monospace;font-size:1rem" />
          <button class="btn btn-primary btn-sm" id="addFriendBtn" style="flex-shrink:0;white-space:nowrap">ì¶”ê°€</button>
        </div>
      </div>

      <!-- ê·¸ë£¹ í•„í„° -->
      <div class="section-title" style="margin-top:8px">ë‚´ ê·¸ë£¹</div>
      <div class="card-sm">
        <div class="input-row">
          <input class="input" id="groupNameInput" placeholder="ìƒˆ ê·¸ë£¹ ì´ë¦„" maxlength="20" />
          <button class="btn btn-primary btn-sm" id="addGroupBtn" style="flex-shrink:0;white-space:nowrap">ì¶”ê°€</button>
        </div>
        <div id="groupList" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px"></div>
      </div>

      <!-- ì¹œêµ¬ ëª©ë¡ -->
      <div class="section-title" style="margin-top:12px">ì¹œêµ¬ ëª©ë¡ <span id="friendCount" class="text-muted">(0)</span></div>
      <div id="friendList">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ‘¥</div>
          <div class="empty-state-title">ì•„ì§ ì¹œêµ¬ê°€ ì—†ì–´ìš”</div>
          <div class="empty-state-sub">ì´ˆëŒ€ì½”ë“œë¡œ ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
        </div>
      </div>

    </div>
  </div>

  <!-- ê·¸ë£¹ ì§€ì • ëª¨ë‹¬ -->
  <div id="groupModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-title">ê·¸ë£¹ ì§€ì •</div>
      <div id="groupModalList" style="max-height:320px;overflow-y:auto"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-secondary btn-sm" style="flex:1" id="groupCancelBtn">ë‹«ê¸°</button>
        <button class="btn btn-primary btn-sm" style="flex:1" id="groupSaveBtn">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item" onclick="location.href='/pages/home.html'">
        <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/create-meeting.html'">
        <span class="nav-icon">â•</span><span>ì•½ì†</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/chat-list.html'">
        <span class="nav-icon">ğŸ’¬</span><span>ì±„íŒ…</span>
      </button>
      <button class="nav-item active">
        <span class="nav-icon">ğŸ‘¥</span><span>ì¹œêµ¬</span>
      </button>
    </div>
  </nav>

  <script type="module">
    import { requireAuth, showToast, copyToClipboard } from '/main.js';
    import { signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { auth } from '/js/firebase-config.js';
    import { addFriendByCode, shareMyCode } from '/js/invite.js';
    import { getFriends, updateUser }  from '/js/db.js';

    let myUid, myProfile;

    const myCodeEl     = document.getElementById('myCode');
    const codeInput    = document.getElementById('codeInput');
    const addFriendBtn = document.getElementById('addFriendBtn');
    const copyCodeBtn  = document.getElementById('copyCodeBtn');
    const shareCodeBtn = document.getElementById('shareCodeBtn');
    const friendList   = document.getElementById('friendList');
    const friendCount  = document.getElementById('friendCount');
    const groupNameInput = document.getElementById('groupNameInput');
    const addGroupBtn    = document.getElementById('addGroupBtn');
    const groupListEl    = document.getElementById('groupList');
    const groupModal     = document.getElementById('groupModal');
    const groupModalList = document.getElementById('groupModalList');
    const groupCancelBtn = document.getElementById('groupCancelBtn');
    const groupSaveBtn   = document.getElementById('groupSaveBtn');

    // ì¸ì¦ í™•ì¸
    try {
      const session = await requireAuth();
      myUid     = session.user.uid;
      myProfile = session.profile;
    } catch { window.location.href = '/index.html'; }

    // í”„ë¡œí•„ í‘œì‹œ
    const avatar = document.getElementById('myAvatar');
    if (myProfile.profileImg) {
      avatar.innerHTML = `<img src="${myProfile.profileImg}" alt="">`;
    } else {
      avatar.textContent = myProfile.nickname?.[0] || '?';
    }
    avatar.addEventListener('click', () => {
      document.getElementById('logoutBtn').style.display =
        document.getElementById('logoutBtn').style.display === 'none' ? '' : 'none';
    });
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        await signOut(auth);
        location.href = '/index.html';
      }
    });

    // ë‚´ ì½”ë“œ í‘œì‹œ
    myCodeEl.textContent = myProfile.inviteCode || '------';

    copyCodeBtn.addEventListener('click', async () => {
      await copyToClipboard(myProfile.inviteCode);
      showToast('ì´ˆëŒ€ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    });

    shareCodeBtn.addEventListener('click', () => shareMyCode(myProfile.inviteCode));

    // ì½”ë“œ ì…ë ¥ ìë™ ëŒ€ë¬¸ì
    codeInput.addEventListener('input', () => {
      codeInput.value = codeInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });

    // URL íŒŒë¼ë¯¸í„°ë¡œ ë“¤ì–´ì˜¨ ì½”ë“œ ìë™ ì…ë ¥/ì¶”ê°€
    const codeParam = new URLSearchParams(location.search).get('code');
    if (codeParam) {
      codeInput.value = codeParam.toUpperCase().replace(/[^A-Z0-9]/g, '');
      setTimeout(() => addFriendBtn.click(), 300);
    }

    // ì¹œêµ¬ ì¶”ê°€
    addFriendBtn.addEventListener('click', async () => {
      const code = codeInput.value.trim();
      if (!code) { showToast('ì´ˆëŒ€ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
      addFriendBtn.disabled = true;
      try {
        const friend = await addFriendByCode(myUid, myProfile, code);
        myProfile.friends = [...(myProfile.friends || []), friend.uid];
        codeInput.value = '';
        showToast(`${friend.nickname}ë‹˜ê³¼ ì¹œêµ¬ê°€ ë˜ì—ˆì–´ìš”!`, 'success');
        renderFriends();
      } catch (e) {
        showToast(e.message, 'error');
      } finally {
        addFriendBtn.disabled = false;
      }
    });

    // ê·¸ë£¹ ìƒíƒœ
    let friendGroups = Array.isArray(myProfile.friendGroups) ? myProfile.friendGroups : [];
    let currentGroupTargetUid = null;
    let selectedGroupId = 'all';

    function saveGroups() {
      myProfile.friendGroups = friendGroups;
      return updateUser(myUid, { friendGroups });
    }

    function renderGroups() {
      if (!friendGroups.length) {
        groupListEl.innerHTML = `
          <div class="badge badge-gray" data-gid="all" style="cursor:pointer">ì „ì²´</div>
          <div class="text-xs text-muted" style="margin-left:6px">ì•„ì§ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        groupListEl.querySelector('[data-gid="all"]').addEventListener('click', () => {
          selectedGroupId = 'all';
          renderGroups();
          renderFriends();
        });
        return;
      }
      const chips = [
        `<div class="badge badge-gray ${selectedGroupId === 'all' ? 'selected' : ''}" data-gid="all" style="cursor:pointer">ì „ì²´</div>`,
        ...friendGroups.map(g => `
          <div class="badge badge-gray ${selectedGroupId === g.id ? 'selected' : ''}" data-gid="${g.id}" style="display:inline-flex;align-items:center;gap:6px;cursor:pointer">
            ${g.name} <span class="text-xs text-muted">(${(g.memberUids || []).length})</span>
            <button class="btn-icon-round" data-del-gid="${g.id}" title="ì‚­ì œ" style="width:18px;height:18px;font-size:12px">âœ–</button>
          </div>
        `),
      ].join('');
      groupListEl.innerHTML = chips;

      groupListEl.querySelectorAll('[data-gid]').forEach(chip => {
        chip.addEventListener('click', (e) => {
          if (e.target?.dataset?.delGid) return;
          selectedGroupId = chip.dataset.gid;
          renderGroups();
          renderFriends();
        });
      });
      groupListEl.querySelectorAll('button[data-del-gid]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const gid = btn.dataset.delGid;
          if (!confirm('ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
          friendGroups = friendGroups.filter(g => g.id !== gid);
          if (selectedGroupId === gid) selectedGroupId = 'all';
          await saveGroups();
          renderGroups();
          renderFriends();
        });
      });
    }

    addGroupBtn.addEventListener('click', async () => {
      const name = groupNameInput.value.trim();
      if (!name) { showToast('ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
      if (friendGroups.some(g => g.name === name)) {
        showToast('ê°™ì€ ì´ë¦„ì˜ ê·¸ë£¹ì´ ìˆìŠµë‹ˆë‹¤', 'error'); return;
      }
      const id = `g_${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
      friendGroups.push({ id, name, memberUids: [] });
      groupNameInput.value = '';
      await saveGroups();
      renderGroups();
    });

    groupCancelBtn.addEventListener('click', () => groupModal.classList.add('hidden'));
    groupSaveBtn.addEventListener('click', async () => {
      if (!currentGroupTargetUid) return;
      const checks = [...groupModalList.querySelectorAll('input[type="checkbox"]')];
      const checkedIds = new Set(checks.filter(c => c.checked).map(c => c.dataset.gid));
      friendGroups = friendGroups.map(g => {
        const set = new Set(g.memberUids || []);
        if (checkedIds.has(g.id)) set.add(currentGroupTargetUid);
        else set.delete(currentGroupTargetUid);
        return { ...g, memberUids: Array.from(set) };
      });
      await saveGroups();
      groupModal.classList.add('hidden');
      renderGroups();
      renderFriends();
    });

    function openGroupModal(uid) {
      currentGroupTargetUid = uid;
      if (!friendGroups.length) {
        groupModalList.innerHTML = '<div class="text-sm text-muted" style="padding:8px 0">ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê·¸ë£¹ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>';
      } else {
        groupModalList.innerHTML = friendGroups.map(g => {
          const checked = (g.memberUids || []).includes(uid) ? 'checked' : '';
          return `
            <label class="friend-item" style="cursor:pointer;gap:8px">
              <input type="checkbox" data-gid="${g.id}" ${checked}>
              <div class="friend-info">
                <div class="friend-name">${g.name}</div>
                <div class="text-xs text-muted">${(g.memberUids || []).length}ëª…</div>
              </div>
            </label>`;
        }).join('');
      }
      groupModal.classList.remove('hidden');
    }

    // ì¹œêµ¬ ëª©ë¡ ë Œë”ë§
    async function renderFriends() {
      const allFriends = await getFriends(myProfile.friends || []);
      const friends = selectedGroupId === 'all'
        ? allFriends
        : allFriends.filter(f =>
            friendGroups.find(g => g.id === selectedGroupId)?.memberUids?.includes(f.uid)
          );
      const totalCount = allFriends.length;
      friendCount.textContent = `(${friends.length})`;
      if (!friends.length) {
        friendList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <div class="empty-state-title">${selectedGroupId === 'all' ? 'ì•„ì§ ì¹œêµ¬ê°€ ì—†ì–´ìš”' : 'ì´ ê·¸ë£¹ì— ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤'}</div>
            <div class="empty-state-sub">${selectedGroupId === 'all' ? 'ì´ˆëŒ€ì½”ë“œë¡œ ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”' : 'ê·¸ë£¹ì— ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”'}</div>
          </div>`;
        return;
      }
      friendCount.textContent = `(${friends.length}/${totalCount})`;
      friendList.innerHTML = friends.map(f => {
        const groupNames = friendGroups
          .filter(g => (g.memberUids || []).includes(f.uid))
          .map(g => g.name);
        return `
        <div class="friend-item">
          <div class="avatar">
            ${f.profileImg ? `<img src="${f.profileImg}" alt="" />` : f.nickname?.[0] || '?'}
          </div>
          <div class="friend-info">
            <div class="friend-name">${f.nickname}</div>
            <div class="friend-code">${f.inviteCode}</div>
            ${groupNames.length ? `<div class="text-xs text-muted">${groupNames.join(', ')}</div>` : ''}
          </div>
          <button class="btn btn-secondary btn-sm" data-group-uid="${f.uid}">ğŸ·ï¸</button>
          <button class="btn btn-secondary btn-sm" onclick="location.href='/pages/chat.html?uid=${f.uid}'">ğŸ’¬</button>
        </div>
      `}).join('');

      friendList.querySelectorAll('button[data-group-uid]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openGroupModal(btn.dataset.groupUid);
        });
      });
    }

    renderGroups();
    renderFriends();
  </script>
</body>
</html>

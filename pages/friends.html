<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì¹œêµ¬ - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="page page-with-nav">
    <div class="page-header">
      <h1>ì¹œêµ¬</h1>
    </div>

    <div class="page-content">
      <!-- ë‚´ ì´ˆëŒ€ì½”ë“œ -->
      <div class="section-title">ë‚´ ì´ˆëŒ€ì½”ë“œ</div>
      <div class="invite-code-box">
        <div class="invite-code-value" id="myCode">------</div>
        <p class="text-xs text-muted" style="text-align:center">ì¹œêµ¬ì—ê²Œ ì´ ì½”ë“œë¥¼ ì•Œë ¤ì£¼ì„¸ìš”</p>
        <div style="display:flex;gap:8px;width:100%">
          <button class="btn btn-secondary" style="flex:1" id="copyCodeBtn">ë³µì‚¬</button>
          <button class="btn btn-primary" style="flex:1" id="shareCodeBtn">ê³µìœ </button>
        </div>
      </div>

      <!-- ì¹œêµ¬ ì¶”ê°€ -->
      <div class="section-title" style="margin-top:8px">ì¹œêµ¬ ì¶”ê°€</div>
      <div class="card-sm">
        <div class="input-row">
          <input class="input" id="codeInput" placeholder="ì¹œêµ¬ ì´ˆëŒ€ì½”ë“œ 6ìë¦¬" maxlength="6"
            style="text-transform:uppercase;letter-spacing:0.12em;font-family:monospace;font-size:1rem" />
          <button class="btn btn-primary btn-sm" id="addFriendBtn" style="flex-shrink:0;white-space:nowrap">ì¶”ê°€</button>
        </div>
      </div>

      <!-- ì¹œêµ¬ ëª©ë¡ -->
      <div class="section-title" style="margin-top:8px">ì¹œêµ¬ ëª©ë¡ <span id="friendCount" class="text-muted">(0)</span></div>
      <div id="friendList">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ‘¥</div>
          <div class="empty-state-title">ì•„ì§ ì¹œêµ¬ê°€ ì—†ì–´ìš”</div>
          <div class="empty-state-sub">ì´ˆëŒ€ì½”ë“œë¡œ ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
  <nav class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item" onclick="location.href='/pages/home.html'">
        <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/create-meeting.html'">
        <span class="nav-icon">â•</span><span>ì•½ì†</span>
      </button>
      <button class="nav-item active">
        <span class="nav-icon">ğŸ‘¥</span><span>ì¹œêµ¬</span>
      </button>
    </div>
  </nav>

  <script type="module">
    import { requireAuth }           from '/main.js';
    import { showToast, copyToClipboard } from '/main.js';
    import { addFriendByCode, shareMyCode } from '/js/invite.js';
    import { getFriends, updateUser }  from '/js/db.js';

    let myUid, myProfile;

    const myCodeEl     = document.getElementById('myCode');
    const codeInput    = document.getElementById('codeInput');
    const addFriendBtn = document.getElementById('addFriendBtn');
    const copyCodeBtn  = document.getElementById('copyCodeBtn');
    const shareCodeBtn = document.getElementById('shareCodeBtn');
    const friendList   = document.getElementById('friendList');
    const friendCount  = document.getElementById('friendCount');

    // ì¸ì¦ í™•ì¸
    try {
      const session = await requireAuth();
      myUid     = session.user.uid;
      myProfile = session.profile;
    } catch { window.location.href = '/index.html'; }

    // ë‚´ ì½”ë“œ í‘œì‹œ
    myCodeEl.textContent = myProfile.inviteCode || '------';

    copyCodeBtn.addEventListener('click', async () => {
      await copyToClipboard(myProfile.inviteCode);
      showToast('ì´ˆëŒ€ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    });

    shareCodeBtn.addEventListener('click', () => shareMyCode(myProfile.inviteCode));

    // ì½”ë“œ ì…ë ¥ ìë™ ëŒ€ë¬¸ì
    codeInput.addEventListener('input', () => {
      codeInput.value = codeInput.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });

    // ì¹œêµ¬ ì¶”ê°€
    addFriendBtn.addEventListener('click', async () => {
      const code = codeInput.value.trim();
      if (!code) { showToast('ì´ˆëŒ€ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
      addFriendBtn.disabled = true;
      try {
        const friend = await addFriendByCode(myUid, myProfile, code);
        myProfile.friends = [...(myProfile.friends || []), friend.uid];
        codeInput.value = '';
        showToast(`${friend.nickname}ë‹˜ê³¼ ì¹œêµ¬ê°€ ë˜ì—ˆì–´ìš”!`, 'success');
        renderFriends();
      } catch (e) {
        showToast(e.message, 'error');
      } finally {
        addFriendBtn.disabled = false;
      }
    });

    // ì¹œêµ¬ ëª©ë¡ ë Œë”ë§
    async function renderFriends() {
      const friends = await getFriends(myProfile.friends || []);
      friendCount.textContent = `(${friends.length})`;
      if (!friends.length) {
        friendList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <div class="empty-state-title">ì•„ì§ ì¹œêµ¬ê°€ ì—†ì–´ìš”</div>
            <div class="empty-state-sub">ì´ˆëŒ€ì½”ë“œë¡œ ì¹œêµ¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</div>
          </div>`;
        return;
      }
      friendList.innerHTML = friends.map(f => `
        <div class="friend-item">
          <div class="avatar">
            ${f.profileImg ? `<img src="${f.profileImg}" alt="" />` : f.nickname?.[0] || '?'}
          </div>
          <div class="friend-info">
            <div class="friend-name">${f.nickname}</div>
            <div class="friend-code">${f.inviteCode}</div>
          </div>
        </div>
      `).join('');
    }

    renderFriends();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì‹¤ì‹œê°„ ì¶”ì  - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body { overflow: hidden; }
    #map-full {
      position: fixed; inset: 0;
      z-index: 0;
    }
    .tracking-ui {
      position: fixed;
      left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 480px;
      z-index: 10;
      pointer-events: none;
    }
    .tracking-top {
      top: 0;
      background: linear-gradient(to bottom, rgba(10,10,15,0.95) 60%, transparent);
      padding: 16px 20px 24px;
      pointer-events: auto;
    }
    .tracking-bottom {
      bottom: 0;
      background: linear-gradient(to top, rgba(10,10,15,0.97) 70%, transparent);
      padding: 20px 20px calc(20px + env(safe-area-inset-bottom, 0px));
      pointer-events: auto;
    }
    .member-list-scroll {
      display: flex; flex-direction: column; gap: 8px;
      max-height: 260px; overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- ì§€ë„ -->
  <div id="map-full"></div>

  <!-- ìƒë‹¨ UI -->
  <div class="tracking-ui tracking-top">
    <div style="display:flex;align-items:center;gap:10px">
      <button class="btn-icon-round" onclick="stopAndGoBack()">â†</button>
      <div style="flex:1">
        <div class="font-bold" id="meetingTitleTrack">ì•½ì†</div>
        <div class="text-xs text-muted" id="placeNameTrack">-</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <div class="status-dot dot-green dot-pulse"></div>
        <span class="text-xs text-green">ì‹¤ì‹œê°„</span>
      </div>
      <button class="btn-icon-round" id="privacyBtn" title="ìœ„ì¹˜ ê³µê°œ/ë¹„ê³µê°œ">ğŸ”“</button>
      <button class="btn-icon-round" onclick="stopAndGoHome()" title="í™ˆìœ¼ë¡œ">ğŸ </button>
    </div>
  </div>

  <!-- í•˜ë‹¨ UI -->
  <div class="tracking-ui tracking-bottom">
    <!-- ETA ëª©ë¡ -->
    <div class="section-title" style="margin-bottom:8px">ë„ì°© ì˜ˆì •</div>
    <div class="member-list-scroll" id="etaList">
      <div class="text-sm text-muted">ìœ„ì¹˜ ì •ë³´ ìˆ˜ì‹  ì¤‘...</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-success" style="flex:1" id="arrivedBtn">
        âœ… ë„ì°© ì™„ë£Œ
      </button>
      <button class="btn btn-secondary btn-sm" id="routeBtn" title="ê²½ë¡œ í‘œì‹œ">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path d="M2 6c3 0 3 4 6 4s3-4 6-4 3 4 6 4" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
          <path d="M2 12c3 0 3 4 6 4s3-4 6-4 3 4 6 4" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"/>
        </svg>
      </button>
      <button class="btn btn-secondary btn-sm" id="centerBtn" title="ë‚´ ìœ„ì¹˜ë¡œ">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
          <circle cx="12" cy="12" r="1.6" fill="currentColor"/>
          <line x1="12" y1="2" x2="12" y2="5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="12" y1="19" x2="12" y2="22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="2" y1="12" x2="5" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="19" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <script type="module">
    import { requireAuth, showToast, getParam, formatDateTime } from '/main.js';
    import { getMeeting, getMember, setMember, subscribeMembers, updateMeeting, updateMemberLocation } from '/js/db.js';
    import { initMap, setMarker, addMemberMarker, centerMapAt, drawRoute, clearRoute } from '/js/kakaomap.js';
    import { startLocationTracking, stopLocationTracking, setLocationPrivate } from '/js/location.js';
    import { calcEta, etaLabel, etaClass } from '/js/eta.js';
    import { WORKER_URL } from '/js/firebase-config.js';

    const meetingId = getParam('id');
    if (!meetingId) { location.href = '/pages/home.html'; }

    // â”€â”€ ë’¤ë¡œê°€ê¸°/í™ˆ í•¨ìˆ˜ëŠ” ì¦‰ì‹œ ì •ì˜ (ë¡œë”© ì¤‘ í´ë¦­í•´ë„ ë™ì‘í•´ì•¼ í•¨) â”€â”€
    function stopAndGoBack() {
      stopLocationTracking();
      location.href = `/pages/meeting.html?id=${meetingId}&noredirect=1`;
    }
    function stopAndGoHome() {
      stopLocationTracking();
      location.href = '/pages/home.html';
    }
    window.stopAndGoBack = stopAndGoBack;
    window.stopAndGoHome = stopAndGoHome;

    (async () => {
    let myUid, myProfile, meeting;

    try {
      const s = await requireAuth();
      myUid = s.user.uid; myProfile = s.profile;
    } catch { location.href = '/index.html'; return; }

    meeting = await getMeeting(meetingId);
    if (!meeting) { location.href = '/pages/home.html'; return; }
    const isActiveNow = () => {
      if (meeting.status === 'active') return true;
      if (meeting.status !== 'pending') return false;
      if (!meeting.activeAt) return false;
      const at = meeting.activeAt.toDate ? meeting.activeAt.toDate() : new Date(meeting.activeAt);
      return at <= new Date();
    };

    const myMember = await getMember(meetingId, myUid);
    if (!myMember || myMember.status === 'declined') {
      showToast('ì°¸ì—¬ í™•ì •ëœ ë©¤ë²„ë§Œ ì¶”ì  í™”ë©´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
      location.href = `/pages/meeting.html?id=${meetingId}&noredirect=1`;
      return;
    }

    // ìƒë‹¨ ì •ë³´
    document.getElementById('meetingTitleTrack').textContent = meeting.title;
    document.getElementById('placeNameTrack').textContent    = meeting.place?.name || '-';

    // ì§€ë„ ì´ˆê¸°í™”
    const map = await initMap('map-full', {
      lat: meeting.place?.lat || 37.5665,
      lng: meeting.place?.lng || 126.978,
      level: 4,
    });

    // ëª©ì ì§€ ë§ˆì»¤
    if (meeting.place?.lat) {
      setMarker(meeting.place.lat, meeting.place.lng, meeting.place.name);
    }

    // ë©¤ë²„ ë§ˆì»¤ ë§µ
    const memberMarkers = {};
    const COLORS = ['#6c63ff', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4'];

    // ë©¤ë²„ ëª©ë¡ ì‹¤ì‹œê°„ êµ¬ë… + ETA ì—…ë°ì´íŠ¸
    let memberColorMap = {};
    let colorIndex = 0;

    subscribeMembers(meetingId, (members) => {
      // ìµœì‹  ë©¤ë²„ ìƒíƒœ ì €ì¥ â†’ ê²½ë¡œ ê°±ì‹ 
      latestMembers = members.filter(m => m.status !== 'declined');
      refreshAllRoutes();

      // ETA ëª©ë¡ ë Œë”ë§
      const etaEl = document.getElementById('etaList');
      const trackable = latestMembers;

      if (!trackable.length) {
        etaEl.innerHTML = '<div class="text-sm text-muted">ì•„ì§ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      etaEl.innerHTML = trackable.map(m => {
        const isMe = m.uid === myUid;
        const transport = { walk: 'ğŸš¶', bike: 'ğŸš²', transit: 'ğŸšŒ', car: 'ğŸš—' }[m.transport] || 'â“';

        let label, cls;
        if (m.status === 'arrived') {
          label = 'ë„ì°©!'; cls = 'eta-arrived';
        } else if (m.locationPrivate && m.uid !== myUid) {
          label = 'ë¹„ê³µê°œ'; cls = 'eta-private';
        } else if (m.status === 'invited' || !m.lat) {
          label = 'ì¤€ë¹„ ì¤‘'; cls = 'eta-waiting';
        } else {
          label = etaLabel(m.eta); cls = etaClass(m.eta);
        }

        // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸ (ìœ„ì¹˜ê°€ ìˆê³  ë¹„ê³µê°œê°€ ì•„ë‹Œ ê²½ìš°ë§Œ)
        if (m.lat && m.lng && m.status !== 'invited' && (!m.locationPrivate || m.uid === myUid)) {
          if (!memberColorMap[m.uid]) {
            memberColorMap[m.uid] = COLORS[colorIndex++ % COLORS.length];
          }
          if (memberMarkers[m.uid]) memberMarkers[m.uid].setMap(null);
          memberMarkers[m.uid] = addMemberMarker(m.lat, m.lng, isMe ? 'ë‚˜' : m.nickname, memberColorMap[m.uid]);
        }

        return `
          <div class="member-eta-card">
            <div class="avatar" style="flex-shrink:0;${m.status === 'invited' || !m.lat ? 'opacity:0.5' : ''}">
              ${m.profileImg ? `<img src="${m.profileImg.replace(/^http:\/\//i,'https://')}">` : (m.nickname?.[0] || '?')}
            </div>
            <div class="member-eta-info">
              <div class="member-eta-name">${m.nickname}${isMe ? ' (ë‚˜)' : ''}</div>
              <div class="member-eta-transport">${transport} ${m.transport ? { walk:'ë„ë³´', bike:'ìì „ê±°', transit:'ëŒ€ì¤‘êµí†µ', car:'ìê°€ìš©' }[m.transport] : 'ì´ë™ìˆ˜ë‹¨ ë¯¸ì„ íƒ'}</div>
            </div>
            <div class="eta-badge ${cls}">${label}</div>
          </div>`;
      }).join('');

      // ìˆ˜ë½í•œ ë©¤ë²„ ì „ì› ë„ì°© í™•ì¸ â†’ ìë™ ì™„ë£Œ (ì¤‘ë³µ ë°©ì§€ í”Œë˜ê·¸ë¡œ í•œ ë²ˆë§Œ ì‹¤í–‰)
      const allArrived = trackable.length > 0 && trackable.every(m => m.status === 'arrived');
      if (allArrived && !allArrivedNotified) {
        allArrivedNotified = true;
        updateMeeting(meetingId, { status: 'done' }).catch(console.warn);
        showToast('ëª¨ë‘ ë„ì°©í–ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success', 5000);
      }
    });

    const destLat = meeting.place?.lat;
    const destLng = meeting.place?.lng;

    let myLastLat = myMember?.lat || null;
    let myLastLng = myMember?.lng || null;
    let routeVisible = false;
    let latestMembers = []; // subscribeMembers ìµœì‹  ìƒíƒœ ë³´ê´€
    let allArrivedNotified = false; // ëª¨ë‘ ë„ì°© í† ìŠ¤íŠ¸ ì¤‘ë³µ ë°©ì§€

    // ë¹„ê³µê°œ ëª¨ë“œ ì´ˆê¸°í™”
    let isPrivateMode = myMember?.locationPrivate || false;
    setLocationPrivate(isPrivateMode);
    const privacyBtn = document.getElementById('privacyBtn');
    privacyBtn.textContent = isPrivateMode ? 'ğŸ”’' : 'ğŸ”“';

    privacyBtn.addEventListener('click', async () => {
      isPrivateMode = !isPrivateMode;
      setLocationPrivate(isPrivateMode);
      if (isPrivateMode) {
        await setMember(meetingId, myUid, { lat: null, lng: null, eta: null, locationPrivate: true });
        if (memberMarkers[myUid]) { memberMarkers[myUid].setMap(null); delete memberMarkers[myUid]; }
        privacyBtn.textContent = 'ğŸ”’';
        showToast('ìœ„ì¹˜ê°€ ë¹„ê³µê°œë¡œ ì „í™˜ëìŠµë‹ˆë‹¤', 'info');
      } else {
        await setMember(meetingId, myUid, { locationPrivate: false });
        privacyBtn.textContent = 'ğŸ”“';
        showToast('ìœ„ì¹˜ê°€ ê³µê°œë¡œ ì „í™˜ëìŠµë‹ˆë‹¤', 'info');
      }
    });

    // ì»¤ìŠ¤í…€ ì¶œë°œì§€ê°€ ìˆê³  ì•„ì§ ìœ„ì¹˜ê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì—…ë¡œë“œ
    if (myMember?.departureLat && myMember?.departureLng && !myMember?.lat && !isPrivateMode) {
      myLastLat = myMember.departureLat;
      myLastLng = myMember.departureLng;
      const initEta = destLat ? await calcEta(myMember.transport || 'walk', myMember.departureLat, myMember.departureLng, destLat, destLng).catch(() => null) : null;
      await updateMemberLocation(meetingId, myUid, myMember.departureLat, myMember.departureLng, initEta).catch(console.warn);
      if (!memberColorMap[myUid]) memberColorMap[myUid] = COLORS[0];
      memberMarkers[myUid] = addMemberMarker(myMember.departureLat, myMember.departureLng, 'ë‚˜', memberColorMap[myUid]);
    }

    // ì „ì²´ ì°¸ì—¬ì ê²½ë¡œ í‘œì‹œ
    async function refreshAllRoutes() {
      if (!routeVisible || !destLat || !destLng) return;
      clearRoute();
      const toRoute = latestMembers.filter(m => m.lat && m.lng && m.status === 'accepted' && (!m.locationPrivate || m.uid === myUid));
      if (!toRoute.length) return;
      await Promise.all(toRoute.map(async (m) => {
        const t = m.transport || 'walk';
        try {
          const res  = await fetch(`${WORKER_URL}/api/route?origin_lat=${m.lat}&origin_lng=${m.lng}&dest_lat=${destLat}&dest_lng=${destLng}&transport=${t}`);
          const data = await res.json();
          if (data.path?.length) {
            const color = memberColorMap[m.uid] || COLORS[colorIndex % COLORS.length];
            drawRoute(data.path, color, data.straight);
          }
        } catch (e) {
          console.warn('Route error for', m.uid, e);
        }
      }));
    }

    document.getElementById('routeBtn').addEventListener('click', async () => {
      routeVisible = !routeVisible;
      const btn = document.getElementById('routeBtn');
      if (routeVisible) {
        btn.style.background  = 'rgba(108,99,255,0.25)';
        btn.style.borderColor = 'var(--accent)';
        btn.style.color       = 'var(--accent2)';
        if (!latestMembers.some(m => m.lat && m.lng && m.status === 'accepted')) {
          showToast('ìœ„ì¹˜ ìˆ˜ì‹  í›„ ê²½ë¡œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤', 'info'); return;
        }
        await refreshAllRoutes();
      } else {
        btn.style.background  = '';
        btn.style.borderColor = '';
        btn.style.color       = '';
        clearRoute();
      }
    });

    startLocationTracking(
      meetingId, myUid,
      (lat, lng) => {
        myLastLat = lat;
        myLastLng = lng;
        if (!memberColorMap[myUid]) memberColorMap[myUid] = COLORS[0];
        // ë‚´ ìœ„ì¹˜ ê°±ì‹  ì‹œ latestMembers ì¦‰ì‹œ ë°˜ì˜ í›„ ê²½ë¡œ ì¬ê·¸ë¦¬ê¸°
        latestMembers = latestMembers.map(m => m.uid === myUid ? { ...m, lat, lng } : m);
        refreshAllRoutes();
      },
      async (lat, lng) => {
        if (!destLat || !destLng) return null;
        const myTransport = myMember?.transport || 'walk';
        return calcEta(myTransport, lat, lng, destLat, destLng);
      },
    );

    // ë„ì°© ì™„ë£Œ
    document.getElementById('arrivedBtn').addEventListener('click', async () => {
      await setMember(meetingId, myUid, { status: 'arrived', eta: 0 });
      stopLocationTracking();
      showToast('ë„ì°© ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…', 'success');
      document.getElementById('arrivedBtn').disabled = true;
      document.getElementById('arrivedBtn').textContent = 'ë„ì°© ì™„ë£Œë¨';

      // FCM ì•Œë¦¼: ë‹¤ë¥¸ ë©¤ë²„ë“¤ì—ê²Œ ì•Œë¦¼
      // (ìƒëµ: ì„œë²„ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì—¬ê¸°ì„œ ê° ë©¤ë²„ í† í°ìœ¼ë¡œ ë°œì†¡)
    });

    // ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
    document.getElementById('centerBtn').addEventListener('click', () => {
      if (myLastLat && myLastLng) {
        centerMapAt(myLastLat, myLastLng, 4);
      } else {
        showToast('ì•„ì§ ìœ„ì¹˜ë¥¼ ë°›ì•„ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤', 'info');
      }
    });

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¶”ì  ì¤‘ì§€
    window.addEventListener('beforeunload', stopLocationTracking);

    })(); // async IIFE ë
  </script>
</body>
</html>

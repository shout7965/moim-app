<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì‹¤ì‹œê°„ ì¶”ì  - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body { overflow: hidden; }
    #map-full {
      position: fixed; inset: 0;
      z-index: 0;
    }
    .tracking-ui {
      position: fixed;
      left: 50%; transform: translateX(-50%);
      width: 100%; max-width: 480px;
      z-index: 10;
      pointer-events: none;
    }
    .tracking-top {
      top: 0;
      background: linear-gradient(to bottom, rgba(10,10,15,0.95) 60%, transparent);
      padding: 16px 20px 24px;
      pointer-events: auto;
    }
    .tracking-bottom {
      bottom: 0;
      background: linear-gradient(to top, rgba(10,10,15,0.97) 70%, transparent);
      padding: 20px 20px calc(20px + env(safe-area-inset-bottom, 0px));
      pointer-events: auto;
    }
    .member-list-scroll {
      display: flex; flex-direction: column; gap: 8px;
      max-height: 260px; overflow-y: auto;
    }
  </style>
</head>
<body>
  <!-- ì§€ë„ -->
  <div id="map-full"></div>

  <!-- ìƒë‹¨ UI -->
  <div class="tracking-ui tracking-top">
    <div style="display:flex;align-items:center;gap:10px">
      <button class="btn-icon-round" onclick="stopAndGoBack()">â†</button>
      <div style="flex:1">
        <div class="font-bold" id="meetingTitleTrack">ì•½ì†</div>
        <div class="text-xs text-muted" id="placeNameTrack">-</div>
      </div>
      <div style="display:flex;align-items:center;gap:6px">
        <div class="status-dot dot-green dot-pulse"></div>
        <span class="text-xs text-green">ì‹¤ì‹œê°„</span>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ UI -->
  <div class="tracking-ui tracking-bottom">
    <!-- ETA ëª©ë¡ -->
    <div class="section-title" style="margin-bottom:8px">ë„ì°© ì˜ˆì •</div>
    <div class="member-list-scroll" id="etaList">
      <div class="text-sm text-muted">ìœ„ì¹˜ ì •ë³´ ìˆ˜ì‹  ì¤‘...</div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-success" style="flex:1" id="arrivedBtn">
        âœ… ë„ì°© ì™„ë£Œ
      </button>
      <button class="btn btn-secondary btn-sm" id="routeBtn" title="ê²½ë¡œ í‘œì‹œ">ğŸ—ºï¸</button>
      <button class="btn btn-secondary btn-sm" id="centerBtn" title="ë‚´ ìœ„ì¹˜ë¡œ">ğŸ“</button>
    </div>
  </div>

  <script type="module">
    import { requireAuth, showToast, getParam, formatDateTime } from '/main.js';
    import { getMeeting, getMember, setMember, subscribeMembers, updateMeeting } from '/js/db.js';
    import { initMap, setMarker, addMemberMarker, centerMapAt, drawRoute, clearRoute } from '/js/kakaomap.js';
    import { startLocationTracking, stopLocationTracking } from '/js/location.js';
    import { calcEta, etaLabel, etaClass } from '/js/eta.js';
    import { WORKER_URL } from '/js/firebase-config.js';

    let myUid, myProfile, meeting;
    const meetingId = getParam('id');
    if (!meetingId) { location.href = '/pages/home.html'; }

    try {
      const s = await requireAuth();
      myUid = s.user.uid; myProfile = s.profile;
    } catch { location.href = '/index.html'; }

    meeting = await getMeeting(meetingId);
    if (!meeting) { location.href = '/pages/home.html'; }

    const myMember = await getMember(meetingId, myUid);
    if (!myMember || myMember.status === 'declined') {
      showToast('ì°¸ì—¬ í™•ì •ëœ ë©¤ë²„ë§Œ ì¶”ì  í™”ë©´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'error');
      location.href = `/pages/meeting.html?id=${meetingId}`;
    }

    // ìƒë‹¨ ì •ë³´
    document.getElementById('meetingTitleTrack').textContent = meeting.title;
    document.getElementById('placeNameTrack').textContent    = meeting.place?.name || '-';

    // ì§€ë„ ì´ˆê¸°í™”
    const map = await initMap('map-full', {
      lat: meeting.place?.lat || 37.5665,
      lng: meeting.place?.lng || 126.978,
      level: 4,
    });

    // ëª©ì ì§€ ë§ˆì»¤
    if (meeting.place?.lat) {
      setMarker(meeting.place.lat, meeting.place.lng, meeting.place.name);
    }

    // ë©¤ë²„ ë§ˆì»¤ ë§µ
    const memberMarkers = {};
    const COLORS = ['#6c63ff', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4'];

    // ë©¤ë²„ ëª©ë¡ ì‹¤ì‹œê°„ êµ¬ë… + ETA ì—…ë°ì´íŠ¸
    let memberColorMap = {};
    let colorIndex = 0;

    subscribeMembers(meetingId, (members) => {
      // ETA ëª©ë¡ ë Œë”ë§
      const etaEl = document.getElementById('etaList');
      const trackable = members.filter(m => m.status !== 'declined');

      if (!trackable.length) {
        etaEl.innerHTML = '<div class="text-sm text-muted">ì•„ì§ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      etaEl.innerHTML = trackable.map(m => {
        const isMe = m.uid === myUid;
        const transport = { walk: 'ğŸš¶', bike: 'ğŸš²', transit: 'ğŸšŒ' }[m.transport] || 'â“';

        let label, cls;
        if (m.status === 'arrived') {
          label = 'ë„ì°©!'; cls = 'eta-arrived';
        } else if (m.status === 'invited' || !m.lat) {
          label = 'ì¤€ë¹„ ì¤‘'; cls = 'eta-waiting';
        } else {
          label = etaLabel(m.eta); cls = etaClass(m.eta);
        }

        // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸ (ìœ„ì¹˜ê°€ ìˆëŠ” ê²½ìš°ë§Œ)
        if (m.lat && m.lng && m.status !== 'invited') {
          if (!memberColorMap[m.uid]) {
            memberColorMap[m.uid] = COLORS[colorIndex++ % COLORS.length];
          }
          if (memberMarkers[m.uid]) memberMarkers[m.uid].setMap(null);
          memberMarkers[m.uid] = addMemberMarker(m.lat, m.lng, isMe ? 'ë‚˜' : m.nickname, memberColorMap[m.uid]);
        }

        return `
          <div class="member-eta-card">
            <div class="avatar" style="flex-shrink:0;${m.status === 'invited' || !m.lat ? 'opacity:0.5' : ''}">
              ${m.profileImg ? `<img src="${m.profileImg}">` : (m.nickname?.[0] || '?')}
            </div>
            <div class="member-eta-info">
              <div class="member-eta-name">${m.nickname}${isMe ? ' (ë‚˜)' : ''}</div>
              <div class="member-eta-transport">${transport} ${m.transport ? { walk:'ë„ë³´', bike:'ìì „ê±°', transit:'ëŒ€ì¤‘êµí†µ' }[m.transport] : 'ì´ë™ìˆ˜ë‹¨ ë¯¸ì„ íƒ'}</div>
            </div>
            <div class="eta-badge ${cls}">${label}</div>
          </div>`;
      }).join('');

      // ìˆ˜ë½í•œ ë©¤ë²„ ì „ì› ë„ì°© í™•ì¸ â†’ ìë™ ì™„ë£Œ
      const accepted = trackable.filter(m => m.status === 'accepted' || m.status === 'arrived');
      const allArrived = accepted.length > 0 && accepted.every(m => m.status === 'arrived');
      if (allArrived && meeting.status !== 'done') {
        updateMeeting(meetingId, { status: 'done' }).catch(console.warn);
        showToast('ëª¨ë‘ ë„ì°©í–ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success', 5000);
      }
    });

    // ë‚´ ìœ„ì¹˜ ì¶”ì  ì‹œì‘
    const transport = myMember?.transport || 'walk';
    const destLat   = meeting.place?.lat;
    const destLng   = meeting.place?.lng;

    let myLastLat = null;
    let myLastLng = null;
    let routeVisible = false;
    const ROUTE_COLOR = { walk: '#22c55e', bike: '#06b6d4', transit: '#6c63ff' };

    async function refreshRoute() {
      if (!routeVisible || !myLastLat || !myLastLng || !destLat || !destLng) return;
      try {
        const res  = await fetch(`${WORKER_URL}/api/route?origin_lat=${myLastLat}&origin_lng=${myLastLng}&dest_lat=${destLat}&dest_lng=${destLng}&transport=${transport}`);
        const data = await res.json();
        if (data.path?.length) drawRoute(data.path, ROUTE_COLOR[transport] || '#6c63ff');
      } catch (e) { console.warn('Route error:', e); }
    }

    document.getElementById('routeBtn').addEventListener('click', async () => {
      routeVisible = !routeVisible;
      const btn = document.getElementById('routeBtn');
      if (routeVisible) {
        btn.style.background    = 'rgba(108,99,255,0.25)';
        btn.style.borderColor   = 'var(--accent)';
        btn.style.color         = 'var(--accent2)';
        if (!myLastLat) { showToast('ìœ„ì¹˜ ìˆ˜ì‹  í›„ ê²½ë¡œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤', 'info'); return; }
        await refreshRoute();
      } else {
        btn.style.background  = '';
        btn.style.borderColor = '';
        btn.style.color       = '';
        clearRoute();
      }
    });

    startLocationTracking(
      meetingId, myUid,
      (lat, lng) => {
        myLastLat = lat;
        myLastLng = lng;
        if (!memberColorMap[myUid]) memberColorMap[myUid] = COLORS[0];
        refreshRoute(); // ìœ„ì¹˜ ê°±ì‹  ì‹œ ê²½ë¡œ ìë™ ì—…ë°ì´íŠ¸
      },
      async (lat, lng) => {
        if (!destLat || !destLng) return null;
        return calcEta(transport, lat, lng, destLat, destLng);
      },
    );

    // ë„ì°© ì™„ë£Œ
    document.getElementById('arrivedBtn').addEventListener('click', async () => {
      await setMember(meetingId, myUid, { status: 'arrived', eta: 0 });
      stopLocationTracking();
      showToast('ë„ì°© ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…', 'success');
      document.getElementById('arrivedBtn').disabled = true;
      document.getElementById('arrivedBtn').textContent = 'ë„ì°© ì™„ë£Œë¨';

      // FCM ì•Œë¦¼: ë‹¤ë¥¸ ë©¤ë²„ë“¤ì—ê²Œ ì•Œë¦¼
      // (ìƒëµ: ì„œë²„ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ì—¬ê¸°ì„œ ê° ë©¤ë²„ í† í°ìœ¼ë¡œ ë°œì†¡)
    });

    // ë‚´ ìœ„ì¹˜ë¡œ ì´ë™
    document.getElementById('centerBtn').addEventListener('click', () => {
      if (myLastLat && myLastLng) {
        centerMapAt(myLastLat, myLastLng, 4);
      } else {
        showToast('ì•„ì§ ìœ„ì¹˜ë¥¼ ë°›ì•„ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤', 'info');
      }
    });

    function stopAndGoBack() {
      stopLocationTracking();
      location.href = `/pages/meeting.html?id=${meetingId}`;
    }
    window.stopAndGoBack = stopAndGoBack;

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¶”ì  ì¤‘ì§€
    window.addEventListener('beforeunload', stopLocationTracking);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì±„íŒ… - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="page page-with-nav">
    <div class="page-header">
      <h1>ì±„íŒ…</h1>
      <button class="btn btn-primary btn-sm" id="newChatBtn">ëŒ€í™” ìƒì„±</button>
    </div>

    <div class="page-content">
      <div id="chatList">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ’¬</div>
          <div class="empty-state-title">ì•„ì§ ëŒ€í™”ê°€ ì—†ì–´ìš”</div>
          <div class="empty-state-sub">ì¹œêµ¬ ëª©ë¡ì—ì„œ ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ëŒ€í™” ìƒì„± ëª¨ë‹¬ -->
  <div id="newChatModal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-title">ëŒ€í™” ìƒì„±</div>
      <div id="newChatList" style="max-height:320px;overflow-y:auto"></div>
      <div class="input-row" style="margin-top:10px">
        <input class="input" id="groupNameInput" placeholder="ë‹¨ì²´ë°© ì´ë¦„ (ì„ íƒ)" maxlength="20" />
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-secondary btn-sm" style="flex:1" id="newChatCancelBtn">ë‹«ê¸°</button>
        <button class="btn btn-primary btn-sm" style="flex:1" id="newChatConfirmBtn">ì‹œì‘</button>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-items">
      <button class="nav-item" onclick="location.href='/pages/home.html'">
        <span class="nav-icon">ğŸ </span><span>í™ˆ</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/create-meeting.html'">
        <span class="nav-icon">â•</span><span>ì•½ì†</span>
      </button>
      <button class="nav-item active">
        <span class="nav-icon">ğŸ’¬</span><span>ì±„íŒ…</span>
      </button>
      <button class="nav-item" onclick="location.href='/pages/friends.html'">
        <span class="nav-icon">ğŸ‘¥</span><span>ì¹œêµ¬</span>
      </button>
    </div>
  </nav>

  <script type="module">
    import { requireAuth, showToast } from '/main.js';
    import { subscribeChats, getFriends, createGroupChat } from '/js/db.js';

    let myUid, myProfile;
    try {
      const s = await requireAuth();
      myUid = s.user.uid;
      myProfile = s.profile;
    } catch { location.href = '/index.html'; }

    const newChatBtn = document.getElementById('newChatBtn');
    const newChatModal = document.getElementById('newChatModal');
    const newChatList = document.getElementById('newChatList');
    const newChatCancelBtn = document.getElementById('newChatCancelBtn');
    const newChatConfirmBtn = document.getElementById('newChatConfirmBtn');
    const groupNameInput = document.getElementById('groupNameInput');
    let friendsCache = [];

    function renderNewChatList() {
      if (!friendsCache.length) {
        newChatList.innerHTML = '<div class="text-sm text-muted" style="padding:8px 0">ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      newChatList.innerHTML = friendsCache.map(f => `
        <label class="friend-item" style="cursor:pointer;gap:8px">
          <input type="checkbox" data-uid="${f.uid}">
          <div class="avatar">
            ${f.profileImg ? `<img src="${f.profileImg}" alt="" />` : f.nickname?.[0] || '?'}
          </div>
          <div class="friend-info">
            <div class="friend-name">${f.nickname}</div>
            <div class="text-xs text-muted">${f.inviteCode || ''}</div>
          </div>
        </label>
      `).join('');
    }

    newChatBtn.addEventListener('click', async () => {
      if (!friendsCache.length) friendsCache = await getFriends(myProfile.friends || []);
      renderNewChatList();
      groupNameInput.value = '';
      newChatModal.classList.remove('hidden');
    });
    newChatCancelBtn.addEventListener('click', () => newChatModal.classList.add('hidden'));
    newChatConfirmBtn.addEventListener('click', async () => {
      const checked = [...newChatList.querySelectorAll('input[type="checkbox"]:checked')];
      if (!checked.length) { showToast('ì¹œêµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }
      const uids = checked.map(c => c.dataset.uid);
      if (uids.length === 1) {
        newChatModal.classList.add('hidden');
        location.href = `/pages/chat.html?uid=${uids[0]}`;
        return;
      }
      const members = friendsCache.filter(f => uids.includes(f.uid));
      const name = groupNameInput.value.trim();
      try {
        const chatId = await createGroupChat(myUid, myProfile, members, name);
        newChatModal.classList.add('hidden');
        location.href = `/pages/chat.html?chatId=${chatId}`;
      } catch (e) {
        showToast('ìƒì„± ì‹¤íŒ¨: ' + e.message, 'error');
      }
    });

    subscribeChats(myUid, (chats) => {
      const el = document.getElementById('chatList');
      if (!chats.length) {
        el.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ’¬</div>
            <div class="empty-state-title">ì•„ì§ ëŒ€í™”ê°€ ì—†ì–´ìš”</div>
            <div class="empty-state-sub">ì¹œêµ¬ ëª©ë¡ì—ì„œ ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”</div>
          </div>`;
        return;
      }
      el.innerHTML = chats.map(c => {
        const isGroup = c.type === 'group' || (c.members || []).length > 2 || c.name;
        let title = '-';
        let avatarHtml = 'ğŸ‘¥';
        let href = `/pages/chat.html?chatId=${c.id}`;
        if (!isGroup) {
          const otherUid = c.members.find(u => u !== myUid);
          const other    = c.memberInfo?.[otherUid] || {};
          title = other.nickname || '-';
          avatarHtml = other.profileImg ? `<img src="${other.profileImg}">` : (other.nickname?.[0] || '?');
          href = `/pages/chat.html?uid=${otherUid}`;
        } else {
          title = c.name || 'ë‹¨ì²´ ëŒ€í™”';
        }
        const lastMsg  = c.lastMessage || 'ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”';
        const lastTime = c.lastAt?.toDate
          ? (() => {
              const d = c.lastAt.toDate();
              const now = new Date();
              if (d.toDateString() === now.toDateString()) {
                return d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit', hour12:true });
              }
              return `${d.getMonth()+1}/${d.getDate()}`;
            })()
          : '';
        return `
          <div class="chat-list-item" onclick="location.href='${href}'">
            <div class="avatar">${avatarHtml}</div>
            <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <span class="font-bold text-sm">${escHtml(title)}</span>
                <span style="font-size:11px;color:var(--text3)">${lastTime}</span>
              </div>
              <div class="chat-last-msg">${escHtml(lastMsg)}</div>
            </div>
          </div>`;
      }).join('');
    });

    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>

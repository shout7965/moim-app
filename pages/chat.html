<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>채팅 - 어디쯤왔어??</title>
  <link rel="stylesheet" href="/style.css" />
  <style>body { overflow: hidden; }</style>
</head>
<body>
  <div class="chat-page">
    <!-- 헤더 -->
    <div class="chat-header">
      <button class="btn-icon-round" id="backBtn">←</button>
      <div class="avatar" id="otherAvatar">?</div>
      <div class="chat-header-info">
        <div class="chat-header-name" id="otherName">-</div>
      </div>
    </div>

    <!-- 메시지 목록 -->
    <div class="chat-messages" id="messageList">
      <div class="text-sm text-muted" style="text-align:center;margin-top:40px">
        대화를 시작해보세요
      </div>
    </div>

    <!-- 입력창 -->
    <div class="chat-input-bar">
      <textarea class="chat-input" id="msgInput" placeholder="메시지 입력..." rows="1"></textarea>
      <button class="chat-send-btn" id="sendBtn" disabled>↑</button>
    </div>
  </div>

  <script type="module">
    import { requireAuth, showToast, getParam } from '/main.js';
    import { getUser, getOrCreateChat, sendMessage, subscribeMessages } from '/js/db.js';

    // ── DOM refs ──
    const input   = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const msgList = document.getElementById('messageList');

    // 모듈 스코프 상태 (init 내부에서 설정)
    let myUid, myProfile, chatId;

    // ── 이벤트 리스너 (항상 먼저 등록) ──
    input.addEventListener('input', () => {
      sendBtn.disabled = !chatId || !input.value.trim();
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 100) + 'px';
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doSend(); }
    });
    sendBtn.addEventListener('click', doSend);
    document.getElementById('backBtn').addEventListener('click', () => history.back());

    async function doSend() {
      const text = input.value.trim();
      if (!text || !chatId) return;
      sendBtn.disabled = true;
      input.value = '';
      input.style.height = 'auto';
      try {
        await sendMessage(chatId, myUid, text);
        msgList.scrollTop = msgList.scrollHeight;
      } catch (e) {
        showToast('전송 실패: ' + e.message, 'error');
      } finally {
        sendBtn.disabled = !input.value.trim();
      }
    }

    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    }

    // ── 비동기 초기화 (async IIFE) ──
    (async () => {
      const otherUid = getParam('uid');
      if (!otherUid) { location.href = '/pages/friends.html'; return; }

      try {
        const s = await requireAuth();
        myUid = s.user.uid; myProfile = s.profile;
      } catch { location.href = '/index.html'; return; }

      let otherProfile;
      try {
        otherProfile = await getUser(otherUid);
      } catch (e) {
        showToast('사용자 정보를 불러올 수 없습니다', 'error'); return;
      }
      if (!otherProfile) {
        showToast('사용자를 찾을 수 없습니다', 'error');
        location.href = '/pages/friends.html'; return;
      }

      // 헤더 렌더링
      document.getElementById('otherName').textContent = otherProfile.nickname;
      const av = document.getElementById('otherAvatar');
      if (otherProfile.profileImg) av.innerHTML = `<img src="${otherProfile.profileImg}">`;
      else av.textContent = otherProfile.nickname?.[0] || '?';

      // 채팅방 생성 or 가져오기
      try {
        chatId = await getOrCreateChat(myUid, otherUid, myProfile, otherProfile);
      } catch (e) {
        showToast('채팅방 연결 실패: ' + e.message, 'error'); return;
      }

      // chatId 설정 후 입력창에 이미 텍스트 있으면 버튼 활성화
      if (input.value.trim()) sendBtn.disabled = false;

      // 메시지 실시간 구독
      let prevDate = '';
      let isFirst  = true;

      subscribeMessages(chatId, (messages) => {
        if (!messages.length) return;
        prevDate = '';
        msgList.innerHTML = messages.map(m => {
          const isMe    = m.uid === myUid;
          const d       = m.createdAt?.toDate ? m.createdAt.toDate() : new Date();
          const dateStr = `${d.getMonth()+1}월 ${d.getDate()}일`;
          const timeStr = d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit', hour12:true });
          let html = '';
          if (dateStr !== prevDate) {
            html += `<div class="chat-date-divider">${dateStr}</div>`;
            prevDate = dateStr;
          }
          html += `
            <div class="chat-bubble-wrap${isMe ? ' mine' : ''}">
              <div class="chat-bubble">${escHtml(m.text)}</div>
              <div class="chat-time">${timeStr}</div>
            </div>`;
          return html;
        }).join('');

        if (isFirst) {
          msgList.scrollTop = msgList.scrollHeight;
          isFirst = false;
        } else {
          const dist = msgList.scrollHeight - msgList.scrollTop - msgList.clientHeight;
          if (dist < 120) msgList.scrollTop = msgList.scrollHeight;
        }
      });
    })();
  </script>
</body>
</html>

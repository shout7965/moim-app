<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>ì±„íŒ… - ì–´ë””ì¯¤ì™”ì–´??</title>
  <link rel="stylesheet" href="/style.css" />
  <style>body { overflow: hidden; }</style>
</head>
<body>
  <div class="chat-page">
    <!-- í—¤ë” -->
    <div class="chat-header">
      <button class="btn-icon-round" id="backBtn">â†</button>
      <div class="avatar" id="otherAvatar">?</div>
      <div class="chat-header-info">
        <div class="chat-header-name" id="otherName">-</div>
      </div>
    </div>

    <!-- ë©”ì‹œì§€ ëª©ë¡ -->
    <div class="chat-messages" id="messageList">
      <div class="text-sm text-muted" style="text-align:center;margin-top:40px">
        ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”
      </div>
    </div>

    <!-- ì…ë ¥ì°½ -->
    <div class="chat-input-bar">
      <textarea class="chat-input" id="msgInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." rows="1"></textarea>
      <button class="chat-send-btn" id="sendBtn" disabled>â†‘</button>
    </div>
  </div>

  <script type="module">
    import { requireAuth, showToast, getParam } from '/main.js';
    import { getUser, getOrCreateChat, getChat, sendMessage, subscribeMessages, notifyChatMembers } from '/js/db.js';

    // â”€â”€ DOM refs â”€â”€
    const input   = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const msgList = document.getElementById('messageList');

    // ëª¨ë“ˆ ìŠ¤ì½”í”„ ìƒíƒœ (init ë‚´ë¶€ì—ì„œ ì„¤ì •)
    let myUid, myProfile, chatId, isGroupChat = false, chatMemberInfo = {};

    // â”€â”€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•­ìƒ ë¨¼ì € ë“±ë¡) â”€â”€
    input.addEventListener('input', () => {
      sendBtn.disabled = !chatId || !input.value.trim();
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 100) + 'px';
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doSend(); }
    });
    sendBtn.addEventListener('click', doSend);
    document.getElementById('backBtn').addEventListener('click', () => history.back());

    async function doSend() {
      const text = input.value.trim();
      if (!text || !chatId) return;
      sendBtn.disabled = true;
      input.value = '';
      input.style.height = 'auto';
      try {
        await sendMessage(chatId, myUid, text);
        await notifyChatMembers(chatId, myUid, myProfile?.nickname || 'ìƒˆ ë©”ì‹œì§€', text);
        msgList.scrollTop = msgList.scrollHeight;
      } catch (e) {
        showToast('ì „ì†¡ ì‹¤íŒ¨: ' + e.message, 'error');
      } finally {
        sendBtn.disabled = !input.value.trim();
      }
    }

    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    }

    // â”€â”€ ë¹„ë™ê¸° ì´ˆê¸°í™” (async IIFE) â”€â”€
    (async () => {
      const otherUid = getParam('uid');
      const chatIdParam = getParam('chatId');
      if (!otherUid && !chatIdParam) { location.href = '/pages/chat-list.html'; return; }

      try {
        const s = await requireAuth();
        myUid = s.user.uid; myProfile = s.profile;
      } catch { location.href = '/index.html'; return; }

      if (chatIdParam) {
        const chat = await getChat(chatIdParam);
        if (!chat) { showToast('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); location.href = '/pages/chat-list.html'; return; }
        if (!chat.members?.includes(myUid)) { showToast('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤', 'error'); location.href = '/pages/chat-list.html'; return; }
        chatId = chat.id;
        isGroupChat = chat.type === 'group' || (chat.members || []).length > 2 || !!chat.name;
        chatMemberInfo = chat.memberInfo || {};
        const title = chat.name || 'ë‹¨ì²´ ëŒ€í™”';
        document.getElementById('otherName').textContent = isGroupChat
          ? `${title} Â· ${chat.members.length}ëª…`
          : (chatMemberInfo[chat.members.find(u => u !== myUid)]?.nickname || '-');
        document.getElementById('otherAvatar').textContent = isGroupChat ? 'ğŸ‘¥' : '?';
      } else {
        let otherProfile;
        try {
          otherProfile = await getUser(otherUid);
        } catch (e) {
          showToast('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error'); return;
        }
        if (!otherProfile) {
          showToast('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
          location.href = '/pages/friends.html'; return;
        }

        // í—¤ë” ë Œë”ë§
        document.getElementById('otherName').textContent = otherProfile.nickname;
        const av = document.getElementById('otherAvatar');
        if (otherProfile.profileImg) av.innerHTML = `<img src="${otherProfile.profileImg}">`;
        else av.textContent = otherProfile.nickname?.[0] || '?';

        // ì±„íŒ…ë°© ìƒì„± or ê°€ì ¸ì˜¤ê¸°
        try {
          chatId = await getOrCreateChat(myUid, otherUid, myProfile, otherProfile);
        } catch (e) {
          showToast('ì±„íŒ…ë°© ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error'); return;
        }
      }

      // chatId ì„¤ì • í›„ ì…ë ¥ì°½ì— ì´ë¯¸ í…ìŠ¤íŠ¸ ìˆìœ¼ë©´ ë²„íŠ¼ í™œì„±í™”
      if (input.value.trim()) sendBtn.disabled = false;

      // ë©”ì‹œì§€ ì‹¤ì‹œê°„ êµ¬ë…
      let prevDate = '';
      let isFirst  = true;

      subscribeMessages(chatId, (messages) => {
        if (!messages.length) return;
        prevDate = '';
        msgList.innerHTML = messages.map(m => {
          const isMe    = m.uid === myUid;
          const d       = m.createdAt?.toDate ? m.createdAt.toDate() : new Date();
          const dateStr = `${d.getMonth()+1}ì›” ${d.getDate()}ì¼`;
          const timeStr = d.toLocaleTimeString('ko-KR', { hour:'2-digit', minute:'2-digit', hour12:true });
          let html = '';
          if (dateStr !== prevDate) {
            html += `<div class="chat-date-divider">${dateStr}</div>`;
            prevDate = dateStr;
          }
          const senderName = isGroupChat && !isMe
            ? `<div class="text-xs text-muted" style="margin:0 0 4px 6px">${escHtml(chatMemberInfo[m.uid]?.nickname || 'ìµëª…')}</div>`
            : '';
          html += `
            <div class="chat-bubble-wrap${isMe ? ' mine' : ''}">
              ${senderName}
              <div class="chat-bubble">${escHtml(m.text)}</div>
              <div class="chat-time">${timeStr}</div>
            </div>`;
          return html;
        }).join('');

        if (isFirst) {
          msgList.scrollTop = msgList.scrollHeight;
          isFirst = false;
        } else {
          const dist = msgList.scrollHeight - msgList.scrollTop - msgList.clientHeight;
          if (dist < 120) msgList.scrollTop = msgList.scrollHeight;
        }
      });
    })();
  </script>
</body>
</html>

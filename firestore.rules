rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Users =====
    match /users/{uid} {
      // 본인만 읽기/쓰기, 친구 추가 시 타인이 쓰기 가능하도록 제한된 허용
      allow read:  if request.auth != null;
      allow create: if request.auth.uid == uid;
      allow update: if request.auth.uid == uid
        || (
          // friends 배열 변경만 허용 (친구 추가/삭제)
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['friends'])
        );
    }

    // ===== Meetings =====
    match /meetings/{meetingId} {
      // 개별 읽기(딥링크/초대링크 진입): 인증된 사용자 누구나
      allow get: if request.auth != null;
      // 목록 쿼리(홈 피드): 호스트 또는 멤버만
      allow list: if request.auth != null
        && (resource.data.hostId == request.auth.uid
            || exists(/databases/$(database)/documents/meetings/$(meetingId)/members/$(request.auth.uid)));
      // 생성은 인증된 사용자
      allow create: if request.auth != null;
      // 수정은 호스트만
      allow update: if request.auth.uid == resource.data.hostId;
      // 삭제는 호스트만
      allow delete: if request.auth.uid == resource.data.hostId;

      // ===== Members =====
      match /members/{uid} {
        // 개별 조회: 본인 또는 호스트/멤버
        allow get: if request.auth != null
          && (request.auth.uid == uid
              || exists(/databases/$(database)/documents/meetings/$(meetingId)/members/$(request.auth.uid))
              || get(/databases/$(database)/documents/meetings/$(meetingId)).data.hostId == request.auth.uid);
        // 목록 조회: 멤버 또는 호스트만
        allow list: if request.auth != null
          && (exists(/databases/$(database)/documents/meetings/$(meetingId)/members/$(request.auth.uid))
              || get(/databases/$(database)/documents/meetings/$(meetingId)).data.hostId == request.auth.uid);
        // 생성: 호스트 또는 딥링크 진입자(본인 uid 일치)
        allow create: if request.auth != null
          && (request.auth.uid == uid
              || get(/databases/$(database)/documents/meetings/$(meetingId)).data.hostId == request.auth.uid);
        // 수정: 본인만
        allow update: if request.auth.uid == uid;
        // 삭제: 호스트만
        allow delete: if get(/databases/$(database)/documents/meetings/$(meetingId)).data.hostId == request.auth.uid;
      }
    }

    // ===== UserMeetings (인덱스) =====
    match /userMeetings/{docId} {
      allow read:  if request.auth != null && resource.data.uid == request.auth.uid;
      allow create: if request.auth != null
        && (request.resource.data.uid == request.auth.uid
            || get(/databases/$(database)/documents/meetings/$(request.resource.data.meetingId)).data.hostId == request.auth.uid);
      allow update: if request.auth != null
        && (request.resource.data.uid == request.auth.uid
            || get(/databases/$(database)/documents/meetings/$(request.resource.data.meetingId)).data.hostId == request.auth.uid);
      allow delete: if request.auth != null
        && (resource.data.uid == request.auth.uid
            || get(/databases/$(database)/documents/meetings/$(resource.data.meetingId)).data.hostId == request.auth.uid);
    }

    // ===== Chats (1:1) =====
    match /chats/{chatId} {
      // get: 멤버이거나 아직 없는 문서 허용 (신규 채팅방 첫 접근 시 getDoc)
      allow get: if request.auth != null
        && (resource == null || request.auth.uid in resource.data.members);
      // list(쿼리): 멤버만
      allow list: if request.auth != null
        && request.auth.uid in resource.data.members;
      // 생성: 본인 uid가 members에 포함
      allow create: if request.auth != null
        && request.auth.uid in request.resource.data.members;
      // 수정/삭제: 멤버만
      allow update, delete: if request.auth != null
        && request.auth.uid in resource.data.members;

      match /messages/{msgId} {
        allow read: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members;
        allow create: if request.auth != null
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.members
          && request.resource.data.uid == request.auth.uid;
      }
    }
  }
}
